
<div align="center">

# ğŸ—ï¸ ATRI æŠ€æœ¯æ¶æ„è“å›¾

### è®¾è®¡æ€è·¯ Â· è¿è¡ŒåŸç† Â· åˆ›æ–°äº®ç‚¹

[![Architecture](https://img.shields.io/badge/Architecture-Serverless-blue?style=for-the-badge&logo=cloudflare)](https://developers.cloudflare.com/workers/)
[![Platform](https://img.shields.io/badge/Platform-Android-green?style=for-the-badge&logo=android)](https://developer.android.com/)
[![AI](https://img.shields.io/badge/AI-OpenAI%20Compatible-orange?style=for-the-badge&logo=openai)](https://platform.openai.com/)

</div>

---

> ğŸ“– **è¿™ä¸æ˜¯"å¯åŠ¨è¯´æ˜"ï¼Œè€Œæ˜¯æŠ€æœ¯è“å›¾ï¼š**
> - è®²æ¸…æ¥š**æˆ‘ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡**ï¼ˆå–èˆ/çº¦æŸ/ç›®æ ‡ï¼‰
> - è®²æ¸…æ¥š**ç³»ç»Ÿåˆ°åº•æ€ä¹ˆè·‘**ï¼ˆä¸€æ¬¡å¯¹è¯æ€ä¹ˆèµ°å®Œã€PAD/æ—¥è®°/è®°å¿†æ€ä¹ˆè”åŠ¨ï¼‰
> - è®²æ¸…æ¥š**åç»­æ€ä¹ˆç»§ç»­å¼€å‘**ï¼ˆæ”¹å“ªé‡Œã€æ€ä¹ˆæ‰©å±•ï¼‰
>
> âš ï¸ **è¯´æ˜**ï¼šæœ¬æ–‡æŒ‰"å½“å‰ä»£ç ç°çŠ¶"å†™ï¼ŒèŠå¤©æ¥å£ç›®å‰æ˜¯**ä¸€æ¬¡æ€§ JSON è¿”å›**ï¼ˆä¸æ˜¯ SSE æµï¼‰ã€‚ä¸ºé¿å…éšç§æ³„éœ²ï¼Œæ–‡ä¸­ä¸å†™çœŸå®åŸŸå/è´¦å·/Keyï¼Œç»Ÿä¸€ç”¨ `<YOUR_WORKER_URL>` å ä½ã€‚

---

## ğŸ“‘ ç›®å½•å¯¼èˆª

<table>
<tr>
<td width="50%">

**æ ¸å¿ƒè®¾è®¡**
- [1. è®¾è®¡ç›®æ ‡ & çº¦æŸ](#1-æˆ‘æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜è®¾è®¡ç›®æ ‡--çº¦æŸ)
- [2. ç³»ç»Ÿæ€»è§ˆ](#2-ç³»ç»Ÿæ€»è§ˆç»„ä»¶ä¸è¾¹ç•Œ)
- [3. æ ¸å¿ƒé“¾è·¯](#3-æ ¸å¿ƒé“¾è·¯ä¸€æ¬¡å¯¹è¯åˆ°åº•æ€ä¹ˆèµ°å®Œä»ç‚¹å‘é€å¼€å§‹)

</td>
<td width="50%">

**åˆ›æ–°äº®ç‚¹**
- [4. PAD + äº²å¯†åº¦è¡°å‡](#4-åˆ›æ–°ç‚¹-1pad--äº²å¯†åº¦è¡°å‡è®©æƒ…ç»ªæœ‰æƒ¯æ€§ä¸æ˜¯ä¸€æ¬¡æ€§è¡¨æ¼”)
- [5. æ—¥è®°å‘é‡è®°å¿†](#5-åˆ›æ–°ç‚¹-2æ—¥è®°-highlights-å‘é‡è®°å¿†ç”¨æç‚¼è¿‡çš„è®°å¿†å»åšæ£€ç´¢)
- [6. ä¸‰æ¡£ææ–™ç³»ç»Ÿ](#6-åˆ›æ–°ç‚¹-3æ—¥è®°ç”¨æˆ·æ¡£æ¡ˆäºšæ‰˜è‰ä¾¿ç­¾åˆ†æµä¸Šæ¸¸--ä¸‰ä¸ªäº§ç‰©ä¸‰ç§ç”¨é€”)
- [7. å·¥å…·æ³¨å†Œæœºåˆ¶](#7-åˆ›æ–°ç‚¹-4å·¥å…·æ³¨å†Œå–ä»£å…¨é‡æ³¨å…¥æŠŠæŸ¥è¯å˜æˆæ¨¡å‹èƒ½åŠ›çš„ä¸€éƒ¨åˆ†)

</td>
</tr>
<tr>
<td>

**å·¥ç¨‹ç»†èŠ‚**
- [8. é™„ä»¶ä¸åª’ä½“æ§åˆ¶](#8-é™„ä»¶ä¸åª’ä½“è®¿é—®æ§åˆ¶ç»™-app-çš„é•¿é“¾æ¥ç»™æ¨¡å‹çš„ç¨³é“¾æ¥)
- [9. API å¥‘çº¦](#9-cloudflare-worker-api-å¥‘çº¦å®Œæ•´å­—æ®µçº§)
- [10. æ•°æ®æ¨¡å‹](#10-æ•°æ®æ¨¡å‹å®Œæ•´d1--r2--vectorize--android-æœ¬åœ°)

</td>
<td>

**å¼€å‘æŒ‡å—**
- [11. å¼€å‘è€…ä¸Šæ‰‹](#11-å¼€å‘è€…ä¸Šæ‰‹æ€ä¹ˆæ”¹ä¸œè¥¿ä¸è®²éƒ¨ç½²)
- [12. æœªæ¥æ¼”è¿›](#12-æœªæ¥æ¼”è¿›ä½ è®¡åˆ’çš„æ–¹å‘å†™åœ¨è“å›¾é‡Œæ–¹ä¾¿åç»­å¯¹é½)
- [é™„å½• A: è‡ªæ£€æ¸…å•](#é™„å½•-aæœ€å°è‡ªæ£€æ¸…å•ä¸ç­‰äºéƒ¨ç½²)

</td>
</tr>
</table>

---

## 1. æˆ‘æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜ï¼ˆè®¾è®¡ç›®æ ‡ & çº¦æŸï¼‰

è¿™ä¸€å¥—ç³»ç»Ÿçš„ç›®æ ‡ä¸æ˜¯"èƒ½èŠå¤©å°±è¡Œ"ï¼Œè€Œæ˜¯åšå‡ºä¸€ä¸ª**é•¿æœŸå¯ç”¨ã€èƒ½è®°äº‹ã€æƒ…ç»ªæœ‰æƒ¯æ€§ã€æˆæœ¬å¯æ§**çš„è§’è‰²å¯¹è¯ç³»ç»Ÿã€‚

### ğŸ¯ 1.1 è®¾è®¡ç›®æ ‡

<table>
<tr>
<th width="20%">ç›®æ ‡</th>
<th width="80%">æè¿°</th>
</tr>
<tr>
<td>ğŸ­ <strong>è§’è‰²ç¨³å®š</strong></td>
<td>äºšæ‰˜è‰ä¸æ˜¯"ä¸‡èƒ½å®¢æœ"ï¼Œå¥¹è¦æœ‰æŒç»­çš„æƒ…ç»ªï¼ˆPADï¼‰å’Œå…³ç³»æ¸©åº¦ï¼ˆäº²å¯†åº¦ï¼‰</td>
</tr>
<tr>
<td>ğŸš« <strong>ä¸ä¹±ç¼–</strong></td>
<td>ä¸ç¡®å®šå°±æ‰¿è®¤ï¼›éœ€è¦å›å¿†å°±å»æŸ¥åŸæ–‡/æ—¥è®°ï¼Œä¸é æ„Ÿè§‰è¡¥å…¨</td>
</tr>
<tr>
<td>ğŸ§  <strong>è®°å¿†å¯æ§</strong></td>
<td>æ—¢è¦"è®°å¾—ä½"ï¼Œåˆè¦"ä¸ä¼šå› ä¸ºå…¨é‡å¡ä¸Šä¸‹æ–‡è€Œå¤±æ§/å¾ˆè´µ"</td>
</tr>
<tr>
<td>ğŸ’° <strong>æˆæœ¬å¯æ§</strong></td>
<td>èŠå¤©ä¸Šä¸‹æ–‡ä¸èƒ½æ— é™é•¿ï¼Œè®°å¿†æ£€ç´¢è¦æŒ‰éœ€</td>
</tr>
<tr>
<td>ğŸ”§ <strong>å·¥ç¨‹å¯æ‰©å±•</strong></td>
<td>åé¢è¦æ”¯æŒ Gemini/Anthropic åŸç”Ÿæ ¼å¼ã€ä¸»åŠ¨æ¶ˆæ¯ç­‰ï¼Œä»Šå¤©çš„ç»“æ„è¦ç•™å‡ºæ‰©å±•ç‚¹</td>
</tr>
<tr>
<td>ğŸ”’ <strong>éšç§ä¸å®‰å…¨</strong></td>
<td>æ‰€æœ‰ API éƒ½è¦é‰´æƒï¼›é™„ä»¶é“¾æ¥è¦èƒ½æ§æ—¶æ•ˆ/å¯æ’¤é”€ï¼›Secrets ä¸è¿›ä»“åº“</td>
</tr>
</table>

### âš ï¸ 1.2 ç°å®çº¦æŸ

| çº¦æŸ | å½±å“ |
|------|------|
| æ¨¡å‹ä¸Šä¸‹æ–‡æœ‰é™ã€è´¹ç”¨æ•æ„Ÿ | ä¸å¯èƒ½æ¯æ¬¡éƒ½æŠŠ"æ‰€æœ‰èŠå¤©è®°å½•+æ‰€æœ‰æ—¥è®°+æ‰€æœ‰è®°å¿†"å¡è¿›å» |
| æ¨¡å‹ä¼šä¸¢å‚æ•°/ç†è§£å | å°¤å…¶æ˜¯å›¾åƒ URL çš„ queryï¼Œç»å¸¸åœ¨æ¨¡å‹ä¾§è¢«ä¸¢æ‰ï¼Œå¯¼è‡´ 401 |
| ç”¨æˆ·å¯èƒ½æ–­ç½‘ | ä¸èƒ½å› ä¸ºæ—¥å¿—å†™å¤±è´¥å°±å®Œå…¨ä¸èƒ½èŠå¤©ï¼›ä½†åˆè¦å°½é‡ä¿è¯åç«¯"æœ‰ææ–™å¯æ€»ç»“" |

---

## 2. ç³»ç»Ÿæ€»è§ˆï¼ˆç»„ä»¶ä¸è¾¹ç•Œï¼‰

æŠŠç³»ç»Ÿæ‹†æˆå››å—ï¼ˆå¯¹åº”ä»“åº“å››ä¸ªç›®å½•ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Android App (ATRI/)                         â”‚
â”‚                    ğŸ“± UI + æœ¬åœ°å­˜å‚¨ (Room)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP JSONï¼ˆåŠ  X-App-Tokenï¼‰
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Cloudflare Worker (worker/)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚     D1      â”‚  â”‚     R2      â”‚  â”‚       Vectorize         â”‚  â”‚
â”‚  â”‚ èŠå¤©æ—¥å¿—    â”‚  â”‚   é™„ä»¶å­˜å‚¨   â”‚  â”‚   æ—¥è®° highlights å‘é‡   â”‚  â”‚
â”‚  â”‚ æ—¥è®°/æ¡£æ¡ˆ   â”‚  â”‚             â”‚  â”‚                         â”‚  â”‚
â”‚  â”‚ çŠ¶æ€/è®¾ç½®   â”‚  â”‚             â”‚  â”‚                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ OpenAI å…¼å®¹æ¥å£
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ä¸Šæ¸¸æ¨¡å‹/Embeddingï¼ˆOpenAI å…¼å®¹æ¥å£ï¼‰                 â”‚
â”‚                   ğŸ¤– Chat / Embeddings API                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ 2.1 ç»„ä»¶èŒè´£ä¸€è§ˆ

<table>
<tr>
<th>ç»„ä»¶</th>
<th>ç›®å½•</th>
<th>èŒè´£</th>
</tr>
<tr>
<td>ğŸ“± <strong>Android App</strong></td>
<td><code>ATRI/</code></td>
<td>
â€¢ UI + æœ¬åœ°ä¿å­˜ï¼ˆRoomï¼‰<br/>
â€¢ ä¸Šä¼ é™„ä»¶åˆ° Workerï¼ˆWorker å†å†™å…¥ R2ï¼‰<br/>
â€¢ æŠŠ"ç”¨æˆ·æ¶ˆæ¯"å’Œ"äºšæ‰˜è‰å›å¤"éƒ½å†™å…¥ Worker çš„ <code>conversation_logs</code>ï¼ˆD1ï¼‰<br/>
â€¢ æŠŠ Worker è¿”å›çš„ mood/intimacy æ˜¾ç¤ºæˆ"çŠ¶æ€"
</td>
</tr>
<tr>
<td>â˜ï¸ <strong>Cloudflare Worker</strong></td>
<td><code>worker/</code></td>
<td>
â€¢ <code>/api/v1/chat</code>ï¼šç”Ÿæˆå›å¤ï¼ˆä¸€æ¬¡æ€§ JSONï¼‰<br/>
â€¢ <code>/conversation/*</code>ï¼šå†™/åˆ /æŸ¥å¯¹è¯æ—¥å¿—<br/>
â€¢ <code>/diary/*</code>ï¼šæŸ¥æ—¥è®°/åˆ—æ—¥è®°/æ‰‹åŠ¨é‡ç”Ÿæˆ<br/>
â€¢ <code>/upload</code> & <code>/media*</code>ï¼šé™„ä»¶ä¸Šä¼ ä¸è®¿é—®æ§åˆ¶<br/>
â€¢ <code>/models</code>ï¼šæ‹‰å–ä¸Šæ¸¸æ¨¡å‹åˆ—è¡¨ç»™ App é€‰<br/>
â€¢ <strong>Cron</strong>ï¼šæ¯å¤©è‡ªåŠ¨ç”Ÿæˆæ—¥è®°/ç”¨æˆ·æ¡£æ¡ˆ/äºšæ‰˜è‰ä¾¿ç­¾ï¼Œå¹¶å†™å‘é‡è®°å¿†
</td>
</tr>
<tr>
<td>ğŸ“ <strong>å…±äº«æç¤ºè¯</strong></td>
<td><code>shared/prompts.json</code></td>
<td>
â€¢ äººæ ¼/æ—¥è®°/æ¡£æ¡ˆ/ä¾¿ç­¾çš„"æ¯æœ¬"<br/>
â€¢ Worker çœŸæ­£è¯»å–çš„æ˜¯ <code>worker/src/config/prompts.json</code>ï¼ˆç”±è„šæœ¬åŒæ­¥ç”Ÿæˆï¼‰
</td>
</tr>
<tr>
<td>ğŸ”„ <strong>åŒæ­¥è„šæœ¬</strong></td>
<td><code>scripts/sync_shared.py</code></td>
<td>
æŠŠ <code>shared/prompts.json</code> åŒæ­¥åˆ° <code>worker/src/config/prompts.json</code>
</td>
</tr>
</table>

---

## 3. æ ¸å¿ƒé“¾è·¯ï¼šä¸€æ¬¡å¯¹è¯åˆ°åº•æ€ä¹ˆèµ°å®Œï¼ˆä»ç‚¹å‘é€å¼€å§‹ï¼‰

è¿™ä¸€èŠ‚æ˜¯æ•´å¥—ç³»ç»Ÿçš„**ä¸»çº¿**ã€‚çœ‹æ‡‚å®ƒï¼Œä½ å°±èƒ½ç†è§£åé¢æ‰€æœ‰è®¾è®¡ã€‚

### ğŸ”„ 3.1 å¯¹è¯é¡ºåºå›¾ï¼ˆç°çŠ¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·  â”‚                    â”‚  Android    â”‚                   â”‚   Worker   â”‚
â”‚        â”‚                    â”‚    App      â”‚                   â”‚            â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                â”‚                                 â”‚
    â”‚  â‘  é€‰æ‹©é™„ä»¶ï¼ˆå¯é€‰ï¼‰              â”‚                                 â”‚
    â”‚  â‘¡ ç‚¹å‡»å‘é€                     â”‚                                 â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                 â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘¢ æœ¬åœ°å…ˆæ’å…¥ messagesï¼ˆRoomï¼‰    â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘£ POST /conversation/log      â”‚
    â”‚                                â”‚    (role=user, å†™å…¥ D1)         â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘¤ POST /api/v1/chat           â”‚
    â”‚                                â”‚    (content + é™„ä»¶ä¿¡æ¯)          â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚                                â”‚         â”‚ â‘¥ é‰´æƒ X-App-Token   â”‚â”‚
    â”‚                                â”‚         â”‚ â‘¦ è¯» D1ï¼šä»Šå¤©+æ˜¨å¤©æ—¥å¿— â”‚â”‚
    â”‚                                â”‚         â”‚ â‘§ è¯» D1ï¼šç”¨æˆ·æ¡£æ¡ˆ     â”‚â”‚
    â”‚                                â”‚         â”‚ â‘¨ è¯» D1ï¼šäºšæ‰˜è‰ä¾¿ç­¾   â”‚â”‚
    â”‚                                â”‚         â”‚ â‘© è¯»/è¡°å‡ user_statesâ”‚â”‚
    â”‚                                â”‚         â”‚ â‘ª ç»„ system prompt   â”‚â”‚
    â”‚                                â”‚         â”‚ â‘« è°ƒå¤§æ¨¡å‹ï¼ˆå·¥å…·å¾ªç¯ï¼‰ â”‚â”‚
    â”‚                                â”‚         â”‚ â‘¬ ä¿å­˜æœ€æ–° user_statesâ”‚â”‚
    â”‚                                â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘­ è¿”å› JSONï¼š                  â”‚
    â”‚                                â”‚     reply + mood + intimacy     â”‚
    â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘® æ’å…¥å›å¤åˆ° messagesï¼ˆRoomï¼‰   â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘¯ POST /conversation/log      â”‚
    â”‚                                â”‚    (role=atri, å†™å…¥ D1)         â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚  â‘° æ˜¾ç¤ºå›å¤                     â”‚                                 â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                 â”‚
    â”‚                                â”‚                                 â”‚
```

### ğŸ’¡ 3.2 "å…ˆå†™æ—¥å¿—ï¼Œå†èŠå¤©"çš„æ ¸å¿ƒåŠ¨æœº

> **å…³é”®è®¾è®¡ç‚¹**

ä½ ä¼šçœ‹åˆ° App åœ¨è°ƒç”¨ `/api/v1/chat` ä¹‹å‰ï¼Œå…ˆ `POST /conversation/log` å†™ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åˆ° D1ã€‚

<table>
<tr>
<th width="50%">âœ… å¥½å¤„</th>
<th width="50%">âš ï¸ å¸¦æ¥çš„é—®é¢˜</th>
</tr>
<tr>
<td>
â€¢ Worker æ„é€ ä¸Šä¸‹æ–‡æ—¶ï¼Œä¸ç”¨ä¿¡ä»»å®¢æˆ·ç«¯"ç»™æˆ‘æœ€è¿‘ N æ¡æ¶ˆæ¯"ï¼Œè€Œæ˜¯ç›´æ¥è¯» D1 çš„å¯¹è¯æ—¥å¿—<br/>
â€¢ æ—¥è®°/æ¡£æ¡ˆ/å‘é‡è®°å¿†éƒ½èƒ½ä»¥ D1 ä¸ºææ–™ï¼Œé“¾è·¯ç»Ÿä¸€
</td>
<td>
Worker è¯»"ä»Šå¤©èŠå¤©è®°å½•"æ—¶ï¼Œå¯èƒ½æŠŠåˆšå†™å…¥çš„è¿™ä¸€æ¡ä¹Ÿè¯»åˆ°å†å²é‡Œï¼Œå¯¼è‡´æ¨¡å‹çœ‹åˆ°é‡å¤å†…å®¹
</td>
</tr>
</table>

**è§£å†³æ–¹æ¡ˆ**ï¼šApp ä¼šæŠŠè¿™æ¡ç”¨æˆ·æ¶ˆæ¯çš„ id ä½œä¸º `logId` ä¼ ç»™ `/api/v1/chat`ï¼ŒWorker è¯»å†å²æ—¶ä¼šå‰”é™¤å®ƒï¼ˆè§ [`worker/src/services/agent-service.ts`](worker/src/services/agent-service.ts) çš„ `excludeLogId`ï¼‰ã€‚

> ğŸ“Œ **ä¸€å¥è¯æ€»ç»“**ï¼š**D1 æ˜¯"èŠå¤©äº‹å®æº"ï¼ŒlogId æ˜¯"å»é‡å¼€å…³"ã€‚**

### ğŸ­ 3.3 ä¸ºä»€ä¹ˆæ—¥å¿—å†™å¤±è´¥ä¹Ÿä¸é˜»å¡èŠå¤©

[`ChatRepository.logConversationSafely(...)`](ATRI/app/src/main/java/me/atri/data/repository/ChatRepository.kt) æ˜¯ `runCatching` åŒ…èµ·æ¥çš„ï¼šå†™æ—¥å¿—å¤±è´¥ä¼šæ‰“å°ï¼Œä½†ä¸ä¼šè®© UI å¡æ­»ã€‚

| å–èˆ | è¯´æ˜ |
|------|------|
| âœ… ç”¨æˆ·ä½“éªŒä¼˜å…ˆ | æ–­ç½‘/è¶…æ—¶ä¹Ÿè¦å°½é‡èƒ½ç»§ç»­èŠï¼ˆè‡³å°‘èƒ½æ‹¿åˆ°å›å¤ï¼‰ |
| âš ï¸ ä»£ä»· | é‚£ä¸€å¤©çš„ D1 ææ–™å¯èƒ½ä¸å®Œæ•´ï¼Œä¼šå½±å“æ—¥è®°/è®°å¿†è´¨é‡ |

> ğŸ’¡ å¦‚æœä½ æ›´é‡è§†"ææ–™å®Œæ•´æ€§"ï¼Œå¯ä»¥æŠŠå®ƒæ”¹æˆå¼ºä¸€è‡´ï¼šæ—¥å¿—å†™å¤±è´¥å°±ä¸å…è®¸ `/api/v1/chat`ã€‚ä½†å½“å‰è®¾è®¡æ›´å"åƒèŠå¤©è½¯ä»¶"ï¼Œè€Œä¸æ˜¯"åƒæ•°æ®åº“åŒæ­¥å·¥å…·"ã€‚

---

## 4. åˆ›æ–°ç‚¹ 1ï¼šPAD + äº²å¯†åº¦è¡°å‡ï¼ˆè®©æƒ…ç»ªæœ‰æƒ¯æ€§ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§è¡¨æ¼”ï¼‰

### ğŸ­ 4.1 PAD æ˜¯ä»€ä¹ˆ

**PAD æ˜¯ä¸‰ç»´æƒ…ç»ªåæ ‡**ï¼š

| ç»´åº¦ | å…¨ç§° | å«ä¹‰ | èŒƒå›´ |
|:----:|------|------|:----:|
| **P** | Pleasure | æ„‰æ‚¦åº¦ï¼ˆå¼€å¿ƒ/ä¸å¼€å¿ƒï¼‰ | `-1` ~ `1` |
| **A** | Arousal | å…´å¥‹åº¦ï¼ˆæœ‰ç²¾ç¥/æ²¡ç²¾ç¥ï¼‰ | `-1` ~ `1` |
| **D** | Dominance | æŒæ§åº¦ï¼ˆå¼ºåŠ¿/ç¤ºå¼±ï¼‰ | `-1` ~ `1` |

### ğŸ’• 4.2 äº²å¯†åº¦æ˜¯ä»€ä¹ˆ

åç«¯è¿˜ç»´æŠ¤ä¸€ä¸ª `intimacy`ï¼ˆèŒƒå›´ `-100` ~ `100`ï¼‰ï¼Œä»£è¡¨"å…³ç³»æ¸©åº¦"ã€‚

> âš ï¸ å®ƒä¸æ˜¯ UI çš„è£…é¥°ï¼Œè€Œæ˜¯ä¼šè¿› promptï¼Œè®©å›å¤é£æ ¼éšç€å…³ç³»å˜åŒ–ã€‚

### ğŸ—ƒï¸ 4.3 æ•°æ®è½åœ¨å“ª

åœ¨ [`worker/db/schema.sql`](worker/db/schema.sql) çš„ **`user_states`** è¡¨ï¼š

```sql
user_id           -- ç”¨æˆ· id
pad_values        -- JSON å­—ç¬¦ä¸²ï¼ˆæ•°ç»„ [p,a,d]ï¼‰
intimacy          -- æ•´æ•°
last_interaction_at / updated_at  -- æ—¶é—´æˆ³
```

### ğŸ”§ 4.4 æ›´æ–°æœºåˆ¶ï¼ˆæ¨¡å‹"ç”³è¯·ä¿®æ”¹"ï¼‰

Worker ç»™æ¨¡å‹æ³¨å†Œäº†ä¸¤ä¸ªå·¥å…·ï¼ˆè§ [`worker/src/services/agent-service.ts`](worker/src/services/agent-service.ts) çš„ `AGENT_TOOLS`ï¼‰ï¼š

```typescript
update_mood(pleasure_delta, arousal_delta, dominance_delta?, reason)
update_intimacy(delta, reason)
```

> ğŸ’¡ **è®¾è®¡æ„å›¾**ï¼šå½“æ¨¡å‹åˆ¤æ–­"æƒ…ç»ª/å…³ç³»åº”è¯¥å˜åŒ–"æ—¶ï¼Œå…ˆé€šè¿‡å·¥å…·æŠŠå˜åŒ–å†™è¿› `user_states`ï¼Œå†å›ç­”ã€‚

<details>
<summary>ğŸ“ å¦‚ä½•è®©æ¨¡å‹æ›´ç§¯æåœ°è°ƒç”¨è¿™äº›å·¥å…·ï¼Ÿ</summary>

å½“å‰ `shared/prompts.json` é‡Œå·²ç»æŠŠ"å›å¿†è¦æŸ¥è¯ã€ä¸ç¡®å®šåˆ«ä¹±ç¼–"å†™å¾—å¾ˆæ˜ç¡®ï¼›ä½†å¯¹ `update_mood/update_intimacy` å¹¶æ²¡æœ‰ç‰¹åˆ«"å¼ºåˆ¶å†™æ­»ä¸€æ¡è§„åˆ™"ã€‚

å¦‚æœä½ å‘ç°æ¨¡å‹å¾ˆå°‘è°ƒç”¨è¿™ä¸¤ä¸ªå·¥å…·ï¼Œæœ€æœ‰æ•ˆçš„åšæ³•æ˜¯ï¼šåœ¨ `shared/prompts.json` çš„ `agent.system` é‡Œè¡¥ä¸€å¥æ˜ç¡®è§„åˆ™ï¼Œä¾‹å¦‚ï¼š

```
å½“ç”¨æˆ·çš„è¯å¼•èµ·æƒ…ç»ªæˆ–å…³ç³»æ³¢åŠ¨æ—¶ï¼Œå…ˆè°ƒç”¨ update_mood / update_intimacyï¼Œå†å›å¤ã€‚
```

è¿™æ¯”"åç«¯å†™ä¸€å † if/else æƒ…ç»ªè§„åˆ™"æ›´å¯æ‰©å±•ï¼šä½ æ¢äººæ ¼/æ¢æ¨¡å‹/æ¢æç¤ºè¯æ—¶ï¼Œä¸éœ€è¦é‡å†™è§„åˆ™å¼•æ“ã€‚

</details>

### ğŸ“‰ 4.5 è¡°å‡æœºåˆ¶

åœ¨ [`worker/src/services/data-service.ts`](worker/src/services/data-service.ts)ï¼š

<table>
<tr>
<th>è¡°å‡ç±»å‹</th>
<th>è§„åˆ™</th>
<th>å«ä¹‰</th>
</tr>
<tr>
<td><strong>PAD è¡°å‡</strong></td>
<td>
â€¢ è·ç¦»ä¸Šæ¬¡äº’åŠ¨ &lt; 0.5 å°æ—¶ï¼šä¸è¡°å‡<br/>
â€¢ å¦åˆ™æŒ‰å°æ—¶è¡°å‡ï¼š<code>factor = 0.92 ^ hours</code>ï¼ˆæœ€å¤šæŒ‰ 48 å°æ—¶ç®—ï¼‰
</td>
<td>ğŸ’­ æ—¶é—´ä¹…äº†ä¼šæ…¢æ…¢å†·é™ä¸‹æ¥</td>
</tr>
<tr>
<td><strong>äº²å¯†åº¦è¡°å‡</strong></td>
<td>
æ¯éš” 3 å¤©ï¼ŒæŠŠäº²å¯†åº¦å¾€ 0 æ¨ 1 ç‚¹ï¼ˆæ­£æ•°å˜å°ï¼Œè´Ÿæ•°å˜å¤§ï¼‰
</td>
<td>ğŸ’” å…³ç³»ä¸ç»´æŠ¤ä¼šæ…¢æ…¢æ·¡</td>
</tr>
<tr>
<td><strong>é¢å¤–çº¦æŸ</strong></td>
<td>
â€¢ <code>update_intimacy</code> çš„ delta è¢« clamp åˆ° <code>[-50, 10]</code><br/>
â€¢ å¦‚æœå½“å‰äº²å¯†åº¦ &lt; 0ï¼Œæƒ³å‡æ¸©ä¼šæ‰“æŠ˜ï¼ˆ<code>*0.6</code>ï¼Œè‡³å°‘ +1ï¼‰
</td>
<td>ğŸ’” "ç ´é•œéš¾åœ†"çš„å·¥ç¨‹åŒ–è¡¨è¾¾</td>
</tr>
</table>

### ğŸ¯ 4.6 å®ƒæ€ä¹ˆå½±å“å›å¤

[`composeAgentSystemPrompt(...)`](worker/src/services/agent-service.ts) ä¼šæŠŠ PAD/äº²å¯†åº¦å†™è¿› system promptï¼ˆæ¥è‡ª `shared/prompts.json` çš„ `agent.system` æ¨¡æ¿ï¼‰ã€‚

> ğŸ“Œ æ‰€ä»¥æ¨¡å‹æ¯æ¬¡å›å¤éƒ½å¸¦ç€"æˆ‘ç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€ã€å’Œä½ æ˜¯ä»€ä¹ˆå…³ç³»"ã€‚

Worker è¿”å›ç»™ App çš„ `mood` å’Œ `intimacy`ï¼Œåªæ˜¯ä¸ºäº† UI èƒ½å±•ç¤º"çŠ¶æ€"ï¼›**æ ¸å¿ƒä»·å€¼åœ¨ prompt ä¾§**ã€‚

> âš ï¸ **æ³¨æ„**ï¼šApp æœ¬åœ°è¿˜æœ‰ä¸€å¥— `intimacy_points`ï¼ˆè§ [`StatusRepository`](ATRI/app/src/main/java/me/atri/data/repository/StatusRepository.kt)ï¼‰ï¼Œç”¨äº UI çš„ç­‰çº§/è¿›åº¦æ¡ã€‚è¿™å’Œåç«¯ `intimacy` ç›®å‰æ˜¯ä¸¤å¥—ä½“ç³»ï¼ˆç°çŠ¶å¦‚æ­¤ï¼Œåç»­å¯ä»¥åšç»Ÿä¸€/åŒæ­¥ï¼‰ã€‚

---

## 5. åˆ›æ–°ç‚¹ 2ï¼šæ—¥è®° highlights å‘é‡è®°å¿†ï¼ˆç”¨"æç‚¼è¿‡çš„è®°å¿†"å»åšæ£€ç´¢ï¼‰

> ğŸ’¡ å¾ˆå¤š RAG çš„å‘æ¥è‡ªä¸€å¥è¯ï¼š**æŠŠå™ªå£°ä¹Ÿå‘é‡åŒ–äº†**ã€‚

æˆ‘è¿™é‡Œåˆ»æ„ä¸åš"æ¯å¥å¯¹è¯éƒ½è¿›å‘é‡åº“"ï¼Œè€Œæ˜¯ï¼š

```
â‘  å…ˆæ¯å¤©ç”Ÿæˆä¸€ç¯‡æ—¥è®°ï¼ˆå¸¦ highlightsï¼‰
           â†“
â‘¡ åªæŠŠ highlightsï¼ˆ4~10 æ¡çŸ­å¥ï¼‰å‘é‡åŒ–
           â†“
â‘¢ æ£€ç´¢æ—¶å…ˆå¬å›"å“ªå¤©å‘ç”Ÿè¿‡ä»€ä¹ˆ"ï¼Œå†æŒ‰éœ€è¯»æ—¥è®°/åŸæ–‡
```

### âœ¨ 5.1 ä¸ºä»€ä¹ˆ highlights æ¯”é€å¥å¯¹è¯æ›´é€‚åˆå‘é‡åŒ–

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| ğŸ¯ **ä¿¡æ¯å¯†åº¦é«˜** | highlights æ˜¯"äº‹ä»¶ + å¯¹è±¡ + æƒ…ç»ª"çš„çŸ­å¥ï¼Œä¸æ˜¯é—²èŠå£æ°´ |
| ğŸ’° **æˆæœ¬å¯æ§** | æ¯å¤©æœ€å¤š 10 æ¡å‘é‡ï¼Œè€Œä¸æ˜¯ä¸Šåƒæ¡ |
| ğŸ² **å¬å›æ›´ç¨³** | æŒ‰"å¤©"å»é‡ï¼Œæ›´åƒäººç±»å›å¿†è·¯å¾„ï¼ˆå…ˆæƒ³èµ·é‚£å¤©ï¼Œå†çœ‹ç»†èŠ‚ï¼‰ |

### ğŸ“ 5.2 å‘é‡å†™å…¥ï¼ˆVectorizeï¼‰

å†™å…¥é€»è¾‘åœ¨ [`worker/src/services/memory-service.ts`](worker/src/services/memory-service.ts) çš„ `upsertDiaryHighlightsMemory`ï¼š

```typescript
// å‘é‡ ID è§„åˆ™
id: `hl:<userId>:<date>:<i>`  // i ä» 0 å¼€å§‹ï¼Œæœ€å¤š 10

// metadataï¼ˆç®€å†™å­—æ®µï¼ŒèŠ‚çœç©ºé—´ï¼‰
{
  u: userId,           // ç”¨æˆ· ID
  c: 'highlight',      // ç±»åˆ«ï¼ˆå›ºå®šï¼‰
  d: date,             // æ—¥æœŸ YYYY-MM-DD
  m: mood,             // æƒ…ç»ª
  imp: 6,              // é‡è¦åº¦ï¼ˆå½“å‰å›ºå®š 6ï¼‰
  ts: timestamp,       // å†™å…¥æ—¶é—´æˆ³
  i: index,            // åºå·
  text: highlightText  // highlight åŸæ–‡
}
```

### ğŸ” 5.3 å‘é‡æ£€ç´¢ï¼ˆsearch_memory å·¥å…·ï¼‰

æ¨¡å‹æƒ³å›å¿†æ—¶ï¼Œä¸æ˜¯åç«¯å¼ºè¡ŒæŠŠä¸€å †è®°å¿†å¡è¿› promptï¼Œè€Œæ˜¯è®©æ¨¡å‹è‡ªå·±è°ƒç”¨ï¼š

```typescript
search_memory(query)
```

**å®ç°æµç¨‹**ï¼ˆ[`worker/src/services/memory-service.ts`](worker/src/services/memory-service.ts)ï¼‰ï¼š

```
â‘  å¯¹ query åš embedding
           â†“
â‘¡ Vectorize.query(topK = max(50, topK*10))
           â†“
â‘¢ è¿‡æ»¤ï¼šåªä¿ç•™ metadata.u == userIdï¼Œä¸” c == highlight
           â†“
â‘£ æŒ‰æ—¥æœŸå»é‡ï¼šåŒä¸€å¤©å¤šæ¡å‘½ä¸­åªä¿ç•™ä¸€æ¡
           â†“
â‘¤ è¿”å› topK å¤©çš„"ç‰‡æ®µ"
```

### ğŸ”— 5.4 å›å¿†åˆ†ä¸¤æ®µï¼šå…ˆæ‰¾æ—¥æœŸï¼Œå†è¯»åŸæ–‡

> ğŸš« **é˜²ä¹±ç¼–çš„å…³é”®è®¾è®¡**

å·¥å…·é“¾åœ¨ [`worker/src/services/agent-service.ts`](worker/src/services/agent-service.ts)ï¼š

| æ­¥éª¤ | å·¥å…· | ä½œç”¨ |
|:----:|------|------|
| 1ï¸âƒ£ | `search_memory(query)` | å‘Šè¯‰æ¨¡å‹"å¯èƒ½ç›¸å…³çš„æ˜¯å“ªå‡ å¤© + ä¸€å¥ç‰‡æ®µ" |
| 2ï¸âƒ£ | `read_diary(date)` | è¯»é‚£å¤©æ—¥è®°ï¼ˆç¬¬ä¸€äººç§°ã€æƒ…ç»ªæ›´æµ“ï¼‰ |
| 2ï¸âƒ£ | `read_conversation(date)` | è¯»é‚£å¤©åŸå§‹èŠå¤©ï¼ˆå¸¦æ—¶é—´æˆ³ï¼Œé€‚åˆå¼•ç”¨åŸè¯ï¼‰ |

> ğŸ“Œ è¿™å°±æ˜¯**"å·¥å…·æ³¨å†Œå–ä»£å…¨é‡æ³¨å…¥"**çš„æ ¸å¿ƒï¼šä¸æŠŠæ‰€æœ‰å†å²å¡è¿›å»ï¼Œåªåœ¨éœ€è¦æ—¶å–è¯ã€‚

---

## 6. åˆ›æ–°ç‚¹ 3ï¼šæ—¥è®°/ç”¨æˆ·æ¡£æ¡ˆ/äºšæ‰˜è‰ä¾¿ç­¾ï¼ˆåˆ†æµä¸Šæ¸¸ + ä¸‰ä¸ªäº§ç‰©ä¸‰ç§ç”¨é€”ï¼‰

### ğŸ“Š 6.1 ä¸‰ä¸ªäº§ç‰©åˆ†åˆ«è§£å†³ä»€ä¹ˆ

<table>
<tr>
<th width="15%">äº§ç‰©</th>
<th width="20%">å­˜å‚¨ä½ç½®</th>
<th width="30%">è§£å†³ä»€ä¹ˆ</th>
<th width="35%">ç»™æ¨¡å‹ä»€ä¹ˆ</th>
</tr>
<tr>
<td>ğŸ“” <strong>æ—¥è®°</strong></td>
<td><code>diary_entries</code></td>
<td>æŠŠ"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ + æˆ‘æ€ä¹ˆæƒ³"å†™æˆå¯è¯»å™äº‹</td>
<td>æƒ…æ„Ÿè¿ç»­æ€§ + highlightsï¼ˆç”¨äºå‘é‡ï¼‰</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>ç”¨æˆ·æ¡£æ¡ˆ</strong></td>
<td><code>user_profiles</code></td>
<td>æŠŠ"äº‹å®/å–œå¥½/é›·åŒº/è¯´è¯é£æ ¼/å…³ç³»è¿›å±•"åšæˆç»“æ„åŒ–æ‘˜è¦</td>
<td>é•¿æœŸç¨³å®šã€ä½å™ªå£°</td>
</tr>
<tr>
<td>ğŸ“ <strong>äºšæ‰˜è‰ä¾¿ç­¾</strong></td>
<td><code>atri_self_reviews</code></td>
<td>æœ€å¤š 3 æ¡çŸ­æé†’</td>
<td>çŸ­æœŸæé†’ã€è¡ŒåŠ¨å¯¼å‘</td>
</tr>
</table>

> ğŸ’¡ è¿™ä¸‰ä¸ªä¸œè¥¿éƒ½ä¸æ˜¯"ä¸ºäº†å¥½çœ‹"ï¼Œè€Œæ˜¯ç»™æ¨¡å‹ä¸‹æ¬¡å¯¹è¯æä¾›**ä¸åŒå±‚æ¬¡çš„ææ–™**ã€‚

### ğŸ”„ 6.2 ç”Ÿæˆé“¾è·¯

#### Cronï¼ˆæ¯å¤©è‡ªåŠ¨è·‘ï¼‰

åœ¨ [`worker/src/jobs/diary-cron.ts`](worker/src/jobs/diary-cron.ts)ï¼š

```
â‘  æ‰¾å‡º"ä»Šå¤©æœ‰èŠå¤©ä½†è¿˜æ²¡ ready æ—¥è®°"çš„ç”¨æˆ·ï¼ˆlistPendingDiaryUsersï¼‰
                    â†“
â‘¡ æ‹‰å½“å¤© conversation_logs â†’ æ‹¼ transcript
                    â†“
â‘¢ ç”Ÿæˆæ—¥è®°ï¼ˆgenerateDiaryFromConversationï¼‰
                    â†“
â‘£ ä¿å­˜æ—¥è®°åˆ° diary_entriesï¼ˆstatus=readyï¼‰
                    â†“
â‘¤ highlights å‘é‡åŒ–å†™å…¥ Vectorize
                    â†“
â‘¥ åˆ·æ–° user_profilesï¼ˆç»“æ„åŒ–æ¡£æ¡ˆï¼‰
                    â†“
â‘¦ åˆ·æ–° atri_self_reviewsï¼ˆä¾¿ç­¾ï¼‰
```

#### æ‰‹åŠ¨é‡ç”Ÿæˆ

`POST /diary/regenerate` ä¼šé‡æ–°ç”Ÿæˆå½“å¤©æ—¥è®°ï¼Œå¹¶ä¸”**å¼ºåˆ¶åˆ·æ–°æ¡£æ¡ˆ/ä¾¿ç­¾**ï¼ˆä¿è¯ä¸‰è€…ä¸€è‡´ï¼‰ã€‚

### ğŸ”€ 6.3 åˆ†æµä¸Šæ¸¸

> âš ï¸ **é‡è¦ï¼šèŠå¤©åˆ«è¢«æ—¥è®°æ‹–æ­»**

| ç”¨é€” | é…ç½®å˜é‡ | è¯´æ˜ |
|------|----------|------|
| ğŸ’¬ Chat | `OPENAI_API_URL` / `OPENAI_API_KEY` | èŠå¤©èµ°è¿™ä¸ª |
| ğŸ“” æ—¥è®°/æ¡£æ¡ˆ/ä¾¿ç­¾ | `DIARY_API_URL` / `DIARY_API_KEY` / `DIARY_MODEL` | å…è®¸èµ°ç‹¬ç«‹ä¸Šæ¸¸ |

**éš”ç¦»çš„æ„ä¹‰**ï¼š
- èŠå¤©è¦å¿«ã€ç¨³å®š
- æ—¥è®°å…è®¸æ…¢ä¸€ç‚¹ã€è´¨é‡é«˜ä¸€ç‚¹ã€ç”šè‡³ç”¨å¦ä¸€å®¶æœåŠ¡
- æ—¥è®°ä¸Šæ¸¸æŒ‚äº†ï¼Œä¸å½±å“èŠå¤©ï¼ˆæœ€å¤šå½“å¤©æ—¥è®°ç”Ÿæˆå¤±è´¥ï¼‰

**å®ç°ä½ç½®**ï¼š
| åŠŸèƒ½ | æ–‡ä»¶ |
|------|------|
| æ—¥è®° | [`worker/src/services/diary-generator.ts`](worker/src/services/diary-generator.ts) |
| æ¡£æ¡ˆ | [`worker/src/services/profile-generator.ts`](worker/src/services/profile-generator.ts) |
| ä¾¿ç­¾ | [`worker/src/services/self-review-generator.ts`](worker/src/services/self-review-generator.ts) |
| ç»Ÿä¸€è¯·æ±‚å°è£… | [`worker/src/services/openai-service.ts`](worker/src/services/openai-service.ts)ï¼ˆæ”¯æŒä¼ å…¥ apiUrl/apiKey è¦†ç›–ï¼‰ |

### ğŸ¤– 6.4 æ¨¡å‹é€‰æ‹©ç­–ç•¥ï¼ˆç°çŠ¶ï¼‰

```
èŠå¤©ï¼šä¼˜å…ˆç”¨å®¢æˆ·ç«¯ä¼ æ¥çš„ modelKeyï¼Œå¦åˆ™ç”¨é»˜è®¤ CHAT_MODEL
          â†“
åç«¯ä¼šæŠŠ modelKey è®°åˆ° user_settings.model_key
          â†“
Cron ä¼šå¤ç”¨å®ƒä½œä¸ºæ—¥è®°/æ¡£æ¡ˆ/ä¾¿ç­¾çš„ modelKey
```

> ğŸ“Œ ä¹Ÿå°±æ˜¯è¯´ï¼š**ç”¨æˆ·é€‰ä»€ä¹ˆæ¨¡å‹ï¼Œæ—¥è®°/æ¡£æ¡ˆ/ä¾¿ç­¾ä¹Ÿä¼šå°½é‡ç”¨åŒä¸€ä¸ªæ¨¡å‹**ï¼ˆé™¤éä½ åœ¨ç¯å¢ƒé‡Œå¼ºåˆ¶é…ç½®åˆ«çš„ç­–ç•¥ï¼‰ã€‚

---

## 7. åˆ›æ–°ç‚¹ 4ï¼šå·¥å…·æ³¨å†Œå–ä»£å…¨é‡æ³¨å…¥ï¼ˆæŠŠ"æŸ¥è¯"å˜æˆæ¨¡å‹èƒ½åŠ›çš„ä¸€éƒ¨åˆ†ï¼‰

> ğŸš« å¾ˆå¤šç³»ç»Ÿçš„åšæ³•æ˜¯ï¼šæŠŠæ‰€æœ‰å†å²ã€æ‰€æœ‰è®°å¿†ã€æ‰€æœ‰æ¡£æ¡ˆæ‹¼æˆä¸€ä¸ªå·¨å¤§ promptã€‚

**è¿™æ ·åšçš„é—®é¢˜**ï¼š
- ğŸ’° è´¹ç”¨é«˜ã€é€Ÿåº¦æ…¢
- ğŸ”Š å™ªå£°å¤§ã€æ¨¡å‹æ›´å®¹æ˜“"é¡ºç€å™ªå£°ç¼–"
- ğŸ”§ è®°å¿†æ›´æ–°/åˆ é™¤å¾ˆéš¾æ§

**æˆ‘è¿™é‡Œçš„åšæ³•**ï¼š

```
â‘  system prompt åªæ”¾"å½“å‰çŠ¶æ€ + ä½¿ç”¨è§„åˆ™ + æ¡£æ¡ˆ/ä¾¿ç­¾çš„æ‘˜è¦"
                    â†“
â‘¡ æŠŠ"å›å¿†/æŸ¥è¯/æ›´æ–°æƒ…ç»ª"åšæˆå·¥å…·
                    â†“
â‘¢ æ˜ç¡®å‘Šè¯‰æ¨¡å‹ï¼šä»€ä¹ˆæ—¶å€™è¯¥ç”¨ä»€ä¹ˆå·¥å…·ï¼ˆå†™åœ¨ prompts é‡Œï¼‰
```

### ğŸ”§ 7.1 å½“å‰å·²æ³¨å†Œçš„å·¥å…·

åœ¨ [`worker/src/services/agent-service.ts`](worker/src/services/agent-service.ts)ï¼š

| å·¥å…· | å‚æ•° | ä½œç”¨ |
|------|------|------|
| `search_memory` | `query` | æ‰¾å¯èƒ½ç›¸å…³çš„æ—¥æœŸ/ç‰‡æ®µï¼ˆæ¥è‡ª highlights å‘é‡ï¼‰ |
| `read_diary` | `date` | è¯»é‚£å¤©æ—¥è®°ï¼ˆç¬¬ä¸€äººç§°ï¼‰ |
| `read_conversation` | `date` | è¯»é‚£å¤©åŸæ–‡èŠå¤©ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ |
| `update_mood` | `pleasure_delta`, `arousal_delta`, `dominance_delta?`, `reason` | æ›´æ–° PAD |
| `update_intimacy` | `delta`, `reason` | æ›´æ–°å…³ç³»æ¸©åº¦ |

### ğŸ”„ 7.2 å·¥å…·å¾ªç¯æ€ä¹ˆè·‘ï¼ˆæœ€å¤š 5 è½®ï¼‰

`runToolLoop(...)` åšçš„äº‹ï¼š

```
â‘  è°ƒä¸Šæ¸¸ /chat/completionsï¼ˆå¸¦ tools + tool_choice=autoï¼‰
                    â†“
â‘¡ å¦‚æœæ¨¡å‹è¿”å› tool_callsï¼šé€ä¸ªæ‰§è¡Œï¼Œç»“æœä½œä¸º role=tool å¡å› messages
                    â†“
â‘¢ ã€å…³é”®ã€‘æ‰§è¡Œå®Œå·¥å…·åï¼Œä¼šç”¨æœ€æ–°çŠ¶æ€é‡å»º system prompt
                    â†“
â‘£ ç»§ç»­ä¸‹ä¸€è½®ï¼Œç›´åˆ°æ¨¡å‹ä¸å†è°ƒç”¨å·¥å…·ï¼Œç»™å‡ºæœ€ç»ˆå›å¤
```

> ğŸ“Œ è¿™ä¿è¯ï¼šæ¨¡å‹"å…ˆæ›´æ–°æƒ…ç»ª/äº²å¯†åº¦"ï¼Œä¸‹ä¸€å¥å›å¤å°±èƒ½ä½“ç°å˜åŒ–ï¼Œä¸ä¼šå»¶è¿Ÿä¸€è½®ã€‚

---

## 8. é™„ä»¶ä¸åª’ä½“è®¿é—®æ§åˆ¶ï¼ˆç»™ App çš„é•¿é“¾æ¥ï¼Œç»™æ¨¡å‹çš„ç¨³é“¾æ¥ï¼‰

### ğŸ“¤ 8.1 ä¸Šä¼ ï¼ˆ`POST /upload`ï¼‰

Worker é‡Œ [`worker/src/routes/media.ts`](worker/src/routes/media.ts)ï¼š

```typescript
// App ä¸Šä¼ æ—¶çš„ Header
X-File-Name / X-File-Type / X-File-Size / X-User-Id

// body æ˜¯æ–‡ä»¶å­—èŠ‚æµ

// Worker å­˜åˆ° R2ï¼Œkey å½¢å¦‚ï¼š
`u/<safeUserId>/<timestamp>-<safeFileName>`
```

**è¿”å›å€¼**ï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `key` | R2 object key |
| `rawUrl` | ä¸ç­¾åçš„ `/media/<key>` |
| `url` | ç»™ App çš„é•¿ç­¾å URLï¼ˆé»˜è®¤ 1 å¹´ï¼‰ |
| `signedUrl` | ç»™æ¨¡å‹çš„çŸ­ç­¾å URLï¼ˆé»˜è®¤ 10 åˆ†é’Ÿï¼Œä¸”æ˜¯è·¯å¾„ç­¾åï¼‰ |

### ğŸ” 8.2 ä¸ºä»€ä¹ˆè¦"è·¯å¾„ç­¾å"

> âš ï¸ **è¿™æ˜¯ä¸ºäº†å¯¹æŠ—æ¨¡å‹ä¸¢ query**

æ¨¡å‹ä¾§ç»å¸¸å‡ºç°è¿™ç§æƒ…å†µï¼š

```
ä½ ç»™äº†ï¼šhttps://.../media/xxx?exp=...&sig=...
æ¨¡å‹è¯·æ±‚æ—¶æŠŠ ?exp&sig ä¸¢äº† â†’ 401
```

æ‰€ä»¥æˆ‘ä¸“é—¨ç»™æ¨¡å‹åšäº†ä¸€ç§å½¢å¼ï¼š

```
/media-s/<exp>/<sig>/<key>
```

è¿™ä¸ªç­¾ååœ¨è·¯å¾„é‡Œï¼Œä¸ä¾èµ– queryï¼Œæ¨¡å‹æ›´ä¸å®¹æ˜“ä¸¢ã€‚

**å®ç°è§**ï¼š
- [`worker/src/utils/media-signature.ts`](worker/src/utils/media-signature.ts) çš„ `signMediaUrlForModel`
- [`worker/src/routes/media.ts`](worker/src/routes/media.ts) çš„ `/media-s/...` è·¯ç”±

### ğŸ”’ 8.3 è®¿é—®æ§åˆ¶ä¼˜å…ˆçº§ï¼ˆç°çŠ¶ï¼‰

**è¯»å– `/media/:key+`**ï¼ˆç»™ Appï¼‰ï¼š

```
â‘  query ç­¾å exp/sig æ ¡éªŒé€šè¿‡
          â†“ï¼ˆå¤±è´¥åˆ™ç»§ç»­ï¼‰
â‘¡ Header X-App-Token æ ¡éªŒé€šè¿‡
          â†“ï¼ˆå¤±è´¥åˆ™ç»§ç»­ï¼‰
â‘¢ query ?token=<APP_TOKEN> æ ¡éªŒé€šè¿‡ï¼ˆå…¼å®¹å…œåº•ï¼Œä¸æ¨èï¼‰
```

**è¯»å– `/media-s/...`**ï¼ˆç»™æ¨¡å‹ï¼‰ï¼š

```
â‘  ä¼˜å…ˆæ ¡éªŒè·¯å¾„ç­¾å
          â†“ï¼ˆä¸é€šè¿‡ï¼‰
â‘¡ èµ° Header/query token å…œåº•
```

**ç­¾åç®—æ³•**ï¼š`HMAC-SHA256(key + "\n" + exp)`ï¼Œsecret ä¼˜å…ˆç”¨ `MEDIA_SIGNING_KEY`ï¼Œå¦åˆ™å›é€€ `APP_TOKEN`ã€‚

---

## 9. Cloudflare Worker API å¥‘çº¦ï¼ˆå®Œæ•´ï½œå­—æ®µçº§ï¼‰

> ğŸ“Œ **ç»Ÿä¸€è§„åˆ™**ï¼šé™¤ `OPTIONS *` å¤–ï¼Œæ‰€æœ‰ä¸šåŠ¡æ¥å£éƒ½éœ€è¦ `X-App-Token`ï¼›è¿”å› JSONã€‚
> CORSï¼š`Access-Control-Allow-Origin: *`ï¼ˆè§ [`worker/src/utils/json-response.ts`](worker/src/utils/json-response.ts)ï¼‰ã€‚

ä¸‹é¢å†™çš„æ˜¯"ç°çŠ¶åè®®"ï¼Œç»§ç»­å¼€å‘è¯·ä»¥æ­¤ä¸ºåŸºå‡†ã€‚

---

### 9.1 `OPTIONS *`

ç”¨äºæµè§ˆå™¨é¢„æ£€ï¼Œè¿”å›ï¼š
```http
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, X-App-Token, Authorization, X-File-Name, X-File-Type, X-File-Size, X-User-Id
```

---

### 9.2 `POST /api/v1/chat`ï¼ˆç”Ÿæˆå›å¤ï¼‰

<details>
<summary>ğŸ“‹ ç‚¹å‡»å±•å¼€è¯¦æƒ…</summary>

**Header**
```http
Content-Type: application/json
X-App-Token: <token>
```

**Request Bodyï¼ˆæ¨èå­—æ®µåï¼‰**
```json
{
  "userId": "uuid",
  "content": "æ–‡æœ¬ï¼Œå¯ä¸ºç©ºï¼ˆåªå‘å›¾æ—¶ï¼‰",
  "logId": "è¿™æ¡ç”¨æˆ·æ¶ˆæ¯åœ¨ D1 çš„ idï¼ˆç”¨äºå»é‡ï¼Œå¯é€‰ï¼‰",
  "platform": "androidï¼ˆå¯é€‰ï¼‰",
  "userName": "å¯é€‰",
  "clientTimeIso": "2026-01-02T22:33:44+08:00ï¼ˆå¯é€‰ï¼‰",
  "modelKey": "ä¸Šæ¸¸æ¨¡å‹ idï¼ˆå¯é€‰ï¼‰",
  "imageUrl": "data:... æˆ– https://...ï¼ˆå¯é€‰ï¼‰",
  "attachments": [
    { "type": "image|document", "url": "https://.../media/...", "mime": "image/png", "name": "a.png", "sizeBytes": 123 }
  ]
}
```

**å…¼å®¹å­—æ®µå**ï¼ˆWorker ä¼šè¯†åˆ«ï¼‰ï¼š
- `user_id`ã€`log_id`ã€`messageId/message_id`
- `message`ï¼ˆä»£æ›¿ contentï¼‰
- `client_time`ï¼ˆä»£æ›¿ clientTimeIsoï¼‰
- `model`ï¼ˆä»£æ›¿ modelKeyï¼‰
- `client`ï¼ˆä»£æ›¿ platformï¼‰

**Responseï¼ˆæˆåŠŸï¼‰**
```json
{
  "reply": "äºšæ‰˜è‰çš„å›å¤",
  "mood": { "p": 0.2, "a": 0.1, "d": 0.0 },
  "action": null,
  "intimacy": 12
}
```

**å¸¸è§é”™è¯¯**
| çŠ¶æ€ç  | å“åº” | åŸå›  |
|:------:|------|------|
| 503 | `{"error":"app_token_missing"}` | Worker æ²¡é…ç½® `APP_TOKEN` |
| 401 | `{"error":"unauthorized"}` | Token ä¸åŒ¹é… |
| 400 | `{"error":"invalid_request","message":"..."}` | ç¼º userId æˆ–å®Œå…¨ç©ºæ¶ˆæ¯ |
| 500 | `{"error":"bio_chat_failed","details":"..."}` | ä¸Šæ¸¸æ¨¡å‹å¤±è´¥ç­‰ |

</details>

---

### 9.3 `POST /conversation/log`ï¼ˆå†™å…¥æ—¥å¿—ï¼‰

<details>
<summary>ğŸ“‹ ç‚¹å‡»å±•å¼€è¯¦æƒ…</summary>

**Header**
```http
Content-Type: application/json
X-App-Token: <token>
```

**Request Body**
```json
{
  "logId": "å¯é€‰ï¼ˆä½œä¸º id å†™å…¥ D1ï¼‰",
  "userId": "uuid",
  "role": "user|atri",
  "content": "æ–‡æœ¬ï¼Œä¸èƒ½ä¸ºç©º",
  "timestamp": 1730000000000,
  "attachments": [
    { "type": "image|document", "url": "https://.../media/...", "mime": "image/png", "name": "a.png", "sizeBytes": 123 }
  ],
  "mood": "{\"p\":0.2,\"a\":0.1,\"d\":0.0}",
  "userName": "å¯é€‰ï¼ˆç”¨æˆ·ä¾§æ˜µç§°ï¼‰",
  "timeZone": "Asia/Shanghaiï¼ˆå¯é€‰ï¼‰",
  "date": "2026-01-02ï¼ˆå¯é€‰ï¼‰"
}
```

**Responseï¼ˆæˆåŠŸï¼‰**
```json
{ "ok": true, "id": "æœ€ç»ˆå†™å…¥çš„id", "date": "YYYY-MM-DD" }
```

**é”™è¯¯**
| çŠ¶æ€ç  | å“åº” | åŸå›  |
|:------:|------|------|
| 400 | `{"error":"invalid_params"}` | ç¼º userId æˆ– role ä¸åˆæ³• |
| 400 | `{"error":"empty_content"}` | content ä¸ºç©º |
| 500 | `{"error":"log_failed"}` | å†™å…¥å¤±è´¥ |

</details>

---

### 9.4 `POST /conversation/delete`ï¼ˆæŒ‰ id æ‰¹é‡åˆ é™¤æ—¥å¿—ï¼‰

**Request**
```json
{ "userId": "uuid", "ids": ["id1","id2"] }
```

**Response**
```json
{ "ok": true, "deleted": 2 }
```

---

### 9.5 `GET /conversation/last`ï¼ˆæŸ¥è¯¢ä¸Šæ¬¡èŠå¤©æ—¥æœŸï¼‰

| Query å‚æ•° | å¿…å¡« | é»˜è®¤å€¼ |
|------------|:----:|--------|
| `userId` | âœ… | - |
| `timeZone` | âŒ | `Asia/Shanghai` |
| `date` | âŒ | æŒ‰ timeZone å–ä»Šå¤© |

**Response**
```json
// æ²¡æœ‰è®°å½•
{ "status": "missing" }

// æœ‰è®°å½•
{ "status": "ok", "date": "YYYY-MM-DD", "daysSince": 3 }
```

---

### 9.6 `GET /diary`ï¼ˆæŸ¥æŸå¤©æ—¥è®°ï¼‰

| Query å‚æ•° | å¿…å¡« |
|------------|:----:|
| `userId` | âœ… |
| `date` | âœ… (YYYY-MM-DD) |

**Response**
```json
// ä¸å­˜åœ¨
{ "status": "missing" }

// å­˜åœ¨
{ "status": "ready|pending|error", "entry": { ... } }
```

---

### 9.7 `GET /diary/list`ï¼ˆåˆ—æ—¥è®°ï¼‰

| Query å‚æ•° | å¿…å¡« | é»˜è®¤å€¼ |
|------------|:----:|--------|
| `userId` | âœ… | - |
| `limit` | âŒ | 7ï¼ˆæœ€å¤§ 30ï¼‰ |

**Response**
```json
{
  "entries": [
    {
      "id": "diary:...",
      "date": "YYYY-MM-DD",
      "summary": "...",
      "content": "...",
      "mood": "...",
      "status": "ready",
      "createdAt": 0,
      "updatedAt": 0
    }
  ]
}
```

---

### 9.8 `POST /diary/regenerate`ï¼ˆé‡ç”ŸæˆæŸå¤©æ—¥è®°ï¼‰

**Request**
```json
{ "userId": "uuid", "date": "YYYY-MM-DD" }
```

**Responseï¼ˆæˆåŠŸï¼‰**
```json
{ "status": "ready", "entry": { ... } }
```

**å¸¸è§é”™è¯¯**
| çŠ¶æ€ç  | å“åº” | åŸå›  |
|:------:|------|------|
| 404 | `{"error":"no_conversation_logs"}` | å½“å¤©æ²¡æœ‰å¯¹è¯æ—¥å¿— |
| 500 | `{"status":"error","error":"..."}` | ç”Ÿæˆå¤±è´¥ |

---

### 9.9 `POST /upload`ï¼ˆä¸Šä¼ é™„ä»¶ï¼‰

**Header**
```http
X-App-Token: <token>
X-File-Name: filename.png
X-File-Type: image/png
X-File-Size: 12345
X-User-Id: uuid
```

**Body**ï¼šæ–‡ä»¶äºŒè¿›åˆ¶

**Response**
```json
{
  "key": "u/xxx/173...-a.png",
  "url": "ç»™Appç”¨çš„é•¿ç­¾åURLï¼ˆå¯èƒ½å¸¦ exp/sigï¼‰",
  "signedUrl": "ç»™æ¨¡å‹ç”¨çš„è·¯å¾„ç­¾åURLï¼ˆ/media-s/...ï¼‰",
  "rawUrl": "ä¸ç­¾åçš„URL",
  "mime": "image/png",
  "size": 123
}
```

---

### 9.10 `GET/HEAD /media/:key+`ï¼ˆè¯»å–é™„ä»¶ï¼‰

å…è®¸ä¸‰ç§æ–¹å¼æ”¾è¡Œï¼ˆè§ç¬¬ 8 èŠ‚ï¼‰ã€‚æˆåŠŸä¼šè¿”å›å¯¹è±¡å†…å®¹ï¼Œå¹¶å¸¦ï¼š
```http
Cache-Control: public, max-age=31536000
```

---

### 9.11 `GET/HEAD /media-s/:exp/:sig/:key+`ï¼ˆè·¯å¾„ç­¾åè¯»å–é™„ä»¶ï¼‰

ç»™æ¨¡å‹ç”¨çš„ç¨³å®šå½¢å¼ï¼Œè§ç¬¬ 8 èŠ‚ã€‚

---

### 9.12 `GET /models`ï¼ˆæ¨¡å‹åˆ—è¡¨ï¼‰

Worker ä¼šä»£ç†è¯·æ±‚ `OPENAI_API_URL + /models`ï¼Œå¹¶æŠŠä¸Šæ¸¸ `data[]` å½’ä¸€æˆï¼š
```json
{
  "models": [
    { "id": "...", "label": "...", "provider": "...", "note": "..." }
  ]
}
```

---

### 9.13 `POST /admin/clear-user`ï¼ˆæ¸…ç†ç”¨æˆ·æ•°æ®ï¼‰

<details>
<summary>ğŸ“‹ ç‚¹å‡»å±•å¼€è¯¦æƒ…</summary>

**Header**
```http
Authorization: Bearer <ADMIN_API_KEY>
```

**Request**
```json
{ "userId": "uuid" }
```

**Response**
```json
{
  "ok": true,
  "userId": "uuid",
  "stats": {
    "diaries": 10,
    "diaryVectors": 100,
    "conversationLogs": 200,
    "mediaObjects": 5,
    "userSettings": 1
  }
}
```

> âš ï¸ **ç°çŠ¶æé†’**ï¼šè¿™ä¸ªæ¥å£å½“å‰ä¸»è¦æ¸…ç† diary/log/vector/media/user_settingsï¼›`user_profiles` / `user_states` / `atri_self_reviews` æ˜¯å¦æ¸…ç†ï¼Œè¦ä»¥ä»£ç å®ç°ä¸ºå‡†ï¼ˆä½ åç»­å¯ä»¥è¡¥é½ï¼‰ã€‚

</details>

---

## 10. æ•°æ®æ¨¡å‹ï¼ˆå®Œæ•´ï½œD1 / R2 / Vectorize / Android æœ¬åœ°ï¼‰

### ğŸ—„ï¸ 10.1 D1ï¼ˆ[`worker/db/schema.sql`](worker/db/schema.sql)ï¼‰

<table>
<tr>
<th colspan="2">conversation_logsï¼ˆå¯¹è¯æ—¥å¿—ï¼‰</th>
</tr>
<tr>
<td><code>id</code></td>
<td>ä¸»é”®ï¼ˆå®¢æˆ·ç«¯å¯ä¼  logIdï¼Œå¦åˆ™åç«¯ç”Ÿæˆ UUIDï¼‰</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>ç”¨æˆ· id</td>
</tr>
<tr>
<td><code>date</code></td>
<td>YYYY-MM-DDï¼ˆä¼˜å…ˆç”¨å®¢æˆ·ç«¯ä¼ å…¥ dateï¼Œå¦åˆ™æŒ‰ timestamp+timeZone è®¡ç®—ï¼‰</td>
</tr>
<tr>
<td><code>role</code></td>
<td><code>user|atri</code></td>
</tr>
<tr>
<td><code>content</code></td>
<td>æ¸…æ´—åçš„æ–‡æœ¬</td>
</tr>
<tr>
<td><code>attachments</code></td>
<td>JSON å­—ç¬¦ä¸²ï¼ˆæ•°ç»„ï¼‰</td>
</tr>
<tr>
<td><code>mood</code></td>
<td>å¯é€‰ï¼ˆApp ä¾§å­˜ JSON å­—ç¬¦ä¸²ï¼‰</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>æ¯«ç§’</td>
</tr>
<tr>
<td><code>user_name</code></td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>time_zone</code></td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>å†™å…¥æ—¶é—´</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">user_statesï¼ˆç”¨æˆ·çŠ¶æ€ï¼‰</th>
</tr>
<tr>
<td><code>pad_values</code></td>
<td>JSON æ•°ç»„å­—ç¬¦ä¸² <code>[p, a, d]</code></td>
</tr>
<tr>
<td><code>intimacy</code></td>
<td>å…³ç³»æ¸©åº¦</td>
</tr>
<tr>
<td><code>last_interaction_at</code> / <code>updated_at</code></td>
<td>ç”¨äºè¡°å‡ä¸æ›´æ–°</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">diary_entriesï¼ˆæ—¥è®°ï¼‰</th>
</tr>
<tr>
<td><code>id</code></td>
<td><code>diary:&lt;userId&gt;:&lt;date&gt;</code></td>
</tr>
<tr>
<td><code>summary</code></td>
<td>highlights æ‹¼æ¥æˆ–æ­£æ–‡æ‘˜è¦</td>
</tr>
<tr>
<td><code>content</code></td>
<td>æ—¥è®°æ­£æ–‡</td>
</tr>
<tr>
<td><code>mood</code></td>
<td>ä¸€ä¸ªè¯</td>
</tr>
<tr>
<td><code>status</code></td>
<td><code>pending|ready|error</code></td>
</tr>
</table>

<table>
<tr>
<th colspan="2">user_settingsï¼ˆç”¨æˆ·è®¾ç½®ï¼‰</th>
</tr>
<tr>
<td><code>model_key</code></td>
<td>ç”¨æˆ·åå¥½æ¨¡å‹</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">user_profilesï¼ˆç”¨æˆ·æ¡£æ¡ˆï¼‰</th>
</tr>
<tr>
<td><code>content</code></td>
<td>JSON å­—ç¬¦ä¸²ï¼ˆäº‹å®/å–œå¥½/é›·åŒº/è¯´è¯é£æ ¼/å…³ç³»è¿›å±•ï¼‰</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">atri_self_reviewsï¼ˆäºšæ‰˜è‰ä¾¿ç­¾ï¼‰</th>
</tr>
<tr>
<td><code>content</code></td>
<td>JSON å­—ç¬¦ä¸²ï¼ˆæ—¥æœŸ/è®¤è¯†å¤©æ•°/ä¾¿ç­¾[]ï¼‰</td>
</tr>
</table>

### ğŸ”¢ 10.2 Vectorizeï¼ˆhighlights å‘é‡ï¼‰

```
id: hl:<userId>:<date>:<i>  (i=0..9)
metadata: è§ç¬¬ 5 èŠ‚
```

### ğŸ“¦ 10.3 R2ï¼ˆé™„ä»¶å¯¹è±¡ï¼‰

```
key: u/<safeUser>/<timestamp>-<safeName>
httpMetadata: contentType / contentDispositionï¼ˆç”¨äºæµè§ˆå™¨/å®¢æˆ·ç«¯æ­£ç¡®è¯†åˆ«ï¼‰
```

### ğŸ“± 10.4 Android æœ¬åœ°ï¼ˆRoom + DataStoreï¼‰

**Room**ï¼š[`ATRI/app/src/main/java/me/atri/data/db/AtriDatabase.kt`](ATRI/app/src/main/java/me/atri/data/db/AtriDatabase.kt)

| è¡¨ | è¯´æ˜ |
|---|---|
| `messages` | æ¶ˆæ¯ï¼ˆå¸¦ isDeleted/isImportant/version/moodï¼‰ |
| `message_versions` | æ¶ˆæ¯ç‰ˆæœ¬ï¼ˆç”¨äºç¼–è¾‘/é‡ç­”ï¼‰ |
| `diary` | æœ¬åœ°ç¼“å­˜æ—¥è®°ï¼ˆå½“å‰ä¸»è¦ç”¨äºå±•ç¤ºï¼‰ |
| `memories` | æœ¬åœ°è®°å¿†è¡¨ï¼ˆæ›´å¤šç”¨äºç»Ÿè®¡/é¢„ç•™ï¼‰ |

**DataStore**ï¼š[`PreferencesStore.kt`](ATRI/app/src/main/java/me/atri/data/datastore/PreferencesStore.kt)

| Key | è¯´æ˜ |
|-----|------|
| `api_url` | Worker URL |
| `app_token` | é‰´æƒ token |
| `model_name` | æ¨¡å‹ id |
| `user_id` / `user_name` | ç”¨æˆ·ä¿¡æ¯ |
| `last_chat_date` | ç¦»çº¿å…œåº• |

---

## 11. å¼€å‘è€…ä¸Šæ‰‹ï¼ˆæ€ä¹ˆæ”¹ä¸œè¥¿ï¼Œä¸è®²éƒ¨ç½²ï¼‰

### ğŸ”§ 11.1 ä½ æœ€å¸¸æ”¹çš„ä¸œè¥¿ â†’ æ”¹å“ªå„¿

| ä½ æƒ³æ”¹ä»€ä¹ˆ | æ”¹å“ªäº›æ–‡ä»¶ |
|------------|------------|
| ğŸ­ æ”¹äººæ ¼/å£å»/å·¥å…·ä½¿ç”¨è§„åˆ™ | [`shared/prompts.json`](shared/prompts.json) çš„ `agent` |
| ğŸ“” æ”¹æ—¥è®°å†™æ³• | [`shared/prompts.json`](shared/prompts.json) çš„ `diary` |
| ğŸ“‹ æ”¹ç”¨æˆ·æ¡£æ¡ˆç»“æ„ | [`shared/prompts.json`](shared/prompts.json) çš„ `profile` + [`worker/src/services/profile-generator.ts`](worker/src/services/profile-generator.ts) |
| ğŸ“ æ”¹ä¾¿ç­¾è§„åˆ™ | [`shared/prompts.json`](shared/prompts.json) çš„ `stickyNote` + [`worker/src/services/self-review-generator.ts`](worker/src/services/self-review-generator.ts) |
| ğŸ”§ åŠ ä¸€ä¸ªæ–°å·¥å…· | [`worker/src/services/agent-service.ts`](worker/src/services/agent-service.ts)ï¼ˆAGENT_TOOLS + executeAgentToolï¼‰ |
| ğŸ§  æ”¹å‘é‡è®°å¿†ç­–ç•¥ | [`worker/src/services/memory-service.ts`](worker/src/services/memory-service.ts) |
| ğŸ” æ”¹é™„ä»¶å®‰å…¨/ç­¾å | [`worker/src/utils/media-signature.ts`](worker/src/utils/media-signature.ts) + [`worker/src/routes/media.ts`](worker/src/routes/media.ts) |
| ğŸ“± App å¢åŠ /è°ƒç”¨æ–°æ¥å£ | [`ATRI/.../AtriApiService.kt`](ATRI/app/src/main/java/me/atri/data/api/AtriApiService.kt) + Repository + ViewModel + UI |

### ğŸš€ 11.2 "å·¥å…·æ³¨å†Œ"æ‰©å±•çš„æ ‡å‡†å§¿åŠ¿

> æ¨èæµç¨‹

```
â‘  å…ˆæƒ³æ¸…æ¥šï¼šè¿™ä¸ªèƒ½åŠ›æ˜¯"è¯»äº‹å®"ï¼ˆé€‚åˆå·¥å…·ï¼‰ï¼Œè¿˜æ˜¯"ç”Ÿæˆæ–‡æœ¬"ï¼ˆé€‚åˆæ¨¡å‹ç›´æ¥å›ç­”ï¼‰
                    â†“
â‘¡ åŠ å·¥å…· schemaï¼ˆè®©æ¨¡å‹çŸ¥é“å‚æ•°æ˜¯ä»€ä¹ˆï¼‰
                    â†“
â‘¢ å®ç°å·¥å…·æ‰§è¡Œï¼ˆå¿…é¡»è¿”å›å¯è¯»çš„ã€å¯ä¿¡çš„å†…å®¹ï¼‰
                    â†“
â‘£ åœ¨ prompts é‡Œå†™æ¸…æ¥š"ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒ"ï¼ˆå¦åˆ™æ¨¡å‹ä¸ä¼šç”¨/ä¹±ç”¨ï¼‰
```

---

## 12. æœªæ¥æ¼”è¿›ï¼ˆä½ è®¡åˆ’çš„æ–¹å‘ï¼Œå†™åœ¨è“å›¾é‡Œæ–¹ä¾¿åç»­å¯¹é½ï¼‰

> ğŸ“Œ è¿™ä¸€èŠ‚åªè®²"è®¡åˆ’æ€ä¹ˆæ‰©"ï¼Œä¸å½±å“ç°çŠ¶å®ç°ã€‚

### ğŸ”„ 12.1 æ”¯æŒ Gemini / Anthropic åŸç”Ÿæ ¼å¼ä¼ è¾“

**ç°çŠ¶**ï¼šæ‰€æœ‰ä¸Šæ¸¸éƒ½æŒ‰ OpenAI å…¼å®¹æ¥å£è°ƒç”¨ï¼ˆ`/chat/completions`ã€`/models`ã€`/embeddings`ï¼‰ã€‚

**æ¨èçš„æ¼”è¿›è·¯çº¿**ï¼š

```
â‘  æŠ½ä¸€å±‚ Provider Adapterï¼ˆæŠŠ messages/tools æ˜ å°„åˆ°å„å®¶æ ¼å¼ï¼‰
                    â†“
â‘¡ ä¿æŒ Worker å†…éƒ¨çš„"å·¥å…· schema + å·¥å…·æ‰§è¡Œ"ä¸å˜
                    â†“
â‘¢ è®© /models è¿”å›"ç»Ÿä¸€çš„ model id + provider ä¿¡æ¯"ï¼ŒApp åªé€‰ä¸€ä¸ª id
```

### ğŸ’¬ 12.2 ä¸»åŠ¨æ¶ˆæ¯ï¼ˆATRI å…ˆå¼€å£ï¼‰

**ç°çŠ¶**ï¼šä¸¥æ ¼çš„ request/responseï¼šç”¨æˆ·å‘ä¸€å¥æ‰æœ‰ä¸€å¥å›ã€‚

**è¦åšä¸»åŠ¨æ¶ˆæ¯ï¼Œä¸€èˆ¬éœ€è¦**ï¼š
- åç«¯å®šæ—¶/äº‹ä»¶è§¦å‘ç”Ÿæˆä¸€æ¡ `role=atri` çš„æ—¥å¿—ï¼ˆå†™å…¥ `conversation_logs`ï¼‰
- App ä¾§å¢åŠ "æ‹‰å–æœªè¯»æ¶ˆæ¯"çš„æ¥å£ä¸æœ¬åœ°è½åº“ç­–ç•¥ï¼ˆé¿å…é‡å¤ã€ä¿è¯é¡ºåºï¼‰
- å¯èƒ½éœ€è¦é€šçŸ¥ï¼ˆæ¨é€ï¼‰æˆ–è½®è¯¢ç­–ç•¥

---

## é™„å½• Aï¼šæœ€å°"è‡ªæ£€æ¸…å•"ï¼ˆä¸ç­‰äºéƒ¨ç½²ï¼‰

> âœ… ä½ è¦éªŒè¯ç³»ç»Ÿ"è®¾è®¡é“¾è·¯"æ˜¯å¦é€šï¼Œæœ€å°‘çœ‹è¿™ä¸‰ä»¶äº‹ï¼š

| # | æ£€æŸ¥é¡¹ | å¦‚ä½•éªŒè¯ |
|:-:|--------|----------|
| 1ï¸âƒ£ | `/api/v1/chat` èƒ½è¿”å› `reply/mood/intimacy` | å‘ä¸€æ¡æ¶ˆæ¯ï¼Œæ£€æŸ¥å“åº”æ ¼å¼ |
| 2ï¸âƒ£ | `/conversation/log` å†™å…¥åï¼Œ`/conversation/last` èƒ½æŸ¥åˆ°æ—¥æœŸ | å†™å…¥æ—¥å¿—ï¼ŒæŸ¥è¯¢ç¡®è®¤ |
| 3ï¸âƒ£ | `/diary/regenerate` åœ¨å½“å¤©æœ‰æ—¥å¿—æ—¶èƒ½ç”Ÿæˆ `ready` æ—¥è®°ï¼Œå¹¶ä¸”åç»­ `search_memory` èƒ½å¬å›åˆ°é‚£å¤© | é‡ç”Ÿæˆæ—¥è®°ï¼Œæµ‹è¯•è®°å¿†æ£€ç´¢ |

---

<div align="center">

---

**ğŸ“– ç›¸å…³æ–‡æ¡£**

[`README.md`](README.md) Â· [`shared/prompts.json`](shared/prompts.json) Â· [`worker/db/schema.sql`](worker/db/schema.sql)

---

<sub>Built with â¤ï¸ for those who believe AI can be more than just a tool</sub>

</div>
