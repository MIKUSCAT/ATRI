
<div align="center">

# ğŸ—ï¸ ATRI æŠ€æœ¯æ¶æ„è“å›¾

### è®¾è®¡æ€è·¯ Â· è¿è¡ŒåŸç† Â· åˆ›æ–°äº®ç‚¹

[![Architecture](https://img.shields.io/badge/Architecture-Dual%20Backend-blue?style=for-the-badge&logo=cloudflare)](https://developers.cloudflare.com/workers/)
[![Platform](https://img.shields.io/badge/Platform-Android-green?style=for-the-badge&logo=android)](https://developer.android.com/)
[![AI](https://img.shields.io/badge/AI-OpenAI%20%7C%20Claude%20%7C%20Gemini-orange?style=for-the-badge&logo=openai)](https://platform.openai.com/)

</div>

---

> ğŸ“– **è¿™ä¸æ˜¯"å¯åŠ¨è¯´æ˜"ï¼Œè€Œæ˜¯æŠ€æœ¯è“å›¾ï¼š**
> - è®²æ¸…æ¥š**æˆ‘ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡**ï¼ˆå–èˆ/çº¦æŸ/ç›®æ ‡ï¼‰
> - è®²æ¸…æ¥š**ç³»ç»Ÿåˆ°åº•æ€ä¹ˆè·‘**ï¼ˆä¸€æ¬¡å¯¹è¯æ€ä¹ˆèµ°å®Œã€çŠ¶æ€èƒ¶å›Š/æ—¥è®°/è®°å¿†æ€ä¹ˆè”åŠ¨ï¼‰
> - è®²æ¸…æ¥š**åç»­æ€ä¹ˆç»§ç»­å¼€å‘**ï¼ˆæ”¹å“ªé‡Œã€æ€ä¹ˆæ‰©å±•ï¼‰
>
> âš ï¸ **è¯´æ˜**ï¼šæœ¬æ–‡æŒ‰"å½“å‰ä»£ç ç°çŠ¶"å†™ï¼ŒèŠå¤©æ¥å£ç›®å‰æ˜¯**ä¸€æ¬¡æ€§ JSON è¿”å›**ï¼ˆä¸æ˜¯ SSE æµï¼‰ã€‚ä¸ºé¿å…éšç§æ³„éœ²ï¼Œæ–‡ä¸­ä¸å†™çœŸå®åŸŸå/è´¦å·/Keyï¼Œç»Ÿä¸€ç”¨ `<YOUR_SERVER_URL>` å ä½ã€‚
>
> ğŸ“Œ **åŒåç«¯è¯´æ˜**ï¼šé¡¹ç›®åŒæ—¶ç»´æŠ¤ Cloudflare Workerï¼ˆ`worker/`ï¼‰å’Œ VPS/Zeaburï¼ˆ`server/`ï¼‰ä¸¤å¥—åç«¯ã€‚æœ¬æ–‡ä»¥ VPS åç«¯ï¼ˆ`server/`ï¼‰ä¸ºä¸»çº¿æè¿°ï¼ŒCloudflare Worker ç‰ˆåŠŸèƒ½åŸºæœ¬ä¸€è‡´ï¼Œå·®å¼‚ä¼šå•ç‹¬æ ‡æ³¨ã€‚

---

## ğŸ“‘ ç›®å½•å¯¼èˆª

<table>
<tr>
<td width="50%">

**æ ¸å¿ƒè®¾è®¡**
- [1. è®¾è®¡ç›®æ ‡ & çº¦æŸ](#1-æˆ‘æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜è®¾è®¡ç›®æ ‡--çº¦æŸ)
- [2. ç³»ç»Ÿæ€»è§ˆ](#2-ç³»ç»Ÿæ€»è§ˆç»„ä»¶ä¸è¾¹ç•Œ)
- [3. æ ¸å¿ƒé“¾è·¯](#3-æ ¸å¿ƒé“¾è·¯ä¸€æ¬¡å¯¹è¯åˆ°åº•æ€ä¹ˆèµ°å®Œä»ç‚¹å‘é€å¼€å§‹)

</td>
<td width="50%">

**åˆ›æ–°äº®ç‚¹**
- [4. çŠ¶æ€èƒ¶å›Š + äº²å¯†åº¦è¡°å‡](#4-åˆ›æ–°ç‚¹-1çŠ¶æ€èƒ¶å›Š--äº²å¯†åº¦è¡°å‡è®©æƒ…ç»ªæœ‰è§†è§‰è¡¨è¾¾å…³ç³»æœ‰æƒ¯æ€§)
- [5. æ—¥è®°å‘é‡è®°å¿†](#5-åˆ›æ–°ç‚¹-2æ—¥è®°-highlights-å‘é‡è®°å¿†ç”¨æç‚¼è¿‡çš„è®°å¿†å»åšæ£€ç´¢)
- [6. ä¸‰æ¡£ææ–™ç³»ç»Ÿ](#6-åˆ›æ–°ç‚¹-3æ—¥è®°ç”¨æˆ·æ¡£æ¡ˆå®æ—¶äº‹å®åˆ†æµä¸Šæ¸¸--ä¸‰ä¸ªäº§ç‰©ä¸‰ç§ç”¨é€”)
- [7. å·¥å…·æ³¨å†Œæœºåˆ¶](#7-åˆ›æ–°ç‚¹-4å·¥å…·æ³¨å†Œå–ä»£å…¨é‡æ³¨å…¥æŠŠæŸ¥è¯å˜æˆæ¨¡å‹èƒ½åŠ›çš„ä¸€éƒ¨åˆ†)

</td>
</tr>
<tr>
<td>

**å·¥ç¨‹ç»†èŠ‚**
- [8. é™„ä»¶ä¸åª’ä½“æ§åˆ¶](#8-é™„ä»¶ä¸åª’ä½“è®¿é—®æ§åˆ¶ç»™-app-çš„é•¿é“¾æ¥ç»™æ¨¡å‹çš„ç¨³é“¾æ¥)
- [9. API å¥‘çº¦](#9-åç«¯-api-å¥‘çº¦å®Œæ•´å­—æ®µçº§)
- [10. æ•°æ®æ¨¡å‹](#10-æ•°æ®æ¨¡å‹å®Œæ•´postgresql--æœ¬åœ°å­˜å‚¨--android-æœ¬åœ°)

</td>
<td>

**å¼€å‘æŒ‡å—**
- [11. å¼€å‘è€…ä¸Šæ‰‹](#11-å¼€å‘è€…ä¸Šæ‰‹æ€ä¹ˆæ”¹ä¸œè¥¿ä¸è®²éƒ¨ç½²)
- [12. æœªæ¥æ¼”è¿›](#12-æœªæ¥æ¼”è¿›ä½ è®¡åˆ’çš„æ–¹å‘å†™åœ¨è“å›¾é‡Œæ–¹ä¾¿åç»­å¯¹é½)
- [é™„å½• A: è‡ªæ£€æ¸…å•](#é™„å½•-aæœ€å°è‡ªæ£€æ¸…å•ä¸ç­‰äºéƒ¨ç½²)

</td>
</tr>
</table>

---

## 1. æˆ‘æƒ³è§£å†³ä»€ä¹ˆé—®é¢˜ï¼ˆè®¾è®¡ç›®æ ‡ & çº¦æŸï¼‰

è¿™ä¸€å¥—ç³»ç»Ÿçš„ç›®æ ‡ä¸æ˜¯"èƒ½èŠå¤©å°±è¡Œ"ï¼Œè€Œæ˜¯åšå‡ºä¸€ä¸ª**é•¿æœŸå¯ç”¨ã€èƒ½è®°äº‹ã€æƒ…ç»ªæœ‰æƒ¯æ€§ã€æˆæœ¬å¯æ§**çš„è§’è‰²å¯¹è¯ç³»ç»Ÿã€‚

### ğŸ¯ 1.1 è®¾è®¡ç›®æ ‡

<table>
<tr>
<th width="20%">ç›®æ ‡</th>
<th width="80%">æè¿°</th>
</tr>
<tr>
<td>ğŸ­ <strong>è§’è‰²ç¨³å®š</strong></td>
<td>äºšæ‰˜è‰ä¸æ˜¯"ä¸‡èƒ½å®¢æœ"ï¼Œå¥¹è¦æœ‰æŒç»­çš„çŠ¶æ€ï¼ˆçŠ¶æ€èƒ¶å›Šï¼‰å’Œå…³ç³»æ¸©åº¦ï¼ˆäº²å¯†åº¦ï¼‰</td>
</tr>
<tr>
<td>ğŸš« <strong>ä¸ä¹±ç¼–</strong></td>
<td>ä¸ç¡®å®šå°±æ‰¿è®¤ï¼›éœ€è¦å›å¿†å°±å»æŸ¥åŸæ–‡/æ—¥è®°ï¼Œä¸é æ„Ÿè§‰è¡¥å…¨ï¼›å¯ä»¥è”ç½‘æŸ¥è¯</td>
</tr>
<tr>
<td>ğŸ§  <strong>è®°å¿†å¯æ§</strong></td>
<td>æ—¢è¦"è®°å¾—ä½"ï¼Œåˆè¦"ä¸ä¼šå› ä¸ºå…¨é‡å¡ä¸Šä¸‹æ–‡è€Œå¤±æ§/å¾ˆè´µ"</td>
</tr>
<tr>
<td>ğŸ’° <strong>æˆæœ¬å¯æ§</strong></td>
<td>èŠå¤©ä¸Šä¸‹æ–‡ä¸èƒ½æ— é™é•¿ï¼Œè®°å¿†æ£€ç´¢è¦æŒ‰éœ€</td>
</tr>
<tr>
<td>ğŸ”§ <strong>å·¥ç¨‹å¯æ‰©å±•</strong></td>
<td>å·²æ”¯æŒ OpenAI/Anthropic/Gemini åŸç”Ÿæ ¼å¼ã€å…¼å®¹ API ç«¯ç‚¹ã€è¿è¡Œæ—¶é…ç½®çƒ­æ›´æ–°</td>
</tr>
<tr>
<td>ğŸ”’ <strong>éšç§ä¸å®‰å…¨</strong></td>
<td>æ‰€æœ‰ API éƒ½è¦é‰´æƒï¼›é™„ä»¶é“¾æ¥è¦èƒ½æ§æ—¶æ•ˆ/å¯æ’¤é”€ï¼›Secrets ç”¨ AES-256-GCM åŠ å¯†å­˜å‚¨</td>
</tr>
</table>

### âš ï¸ 1.2 ç°å®çº¦æŸ

| çº¦æŸ | å½±å“ |
|------|------|
| æ¨¡å‹ä¸Šä¸‹æ–‡æœ‰é™ã€è´¹ç”¨æ•æ„Ÿ | ä¸å¯èƒ½æ¯æ¬¡éƒ½æŠŠ"æ‰€æœ‰èŠå¤©è®°å½•+æ‰€æœ‰æ—¥è®°+æ‰€æœ‰è®°å¿†"å¡è¿›å» |
| æ¨¡å‹ä¼šä¸¢å‚æ•°/ç†è§£å | å°¤å…¶æ˜¯å›¾åƒ URL çš„ queryï¼Œç»å¸¸åœ¨æ¨¡å‹ä¾§è¢«ä¸¢æ‰ï¼Œå¯¼è‡´ 401 |
| ç”¨æˆ·å¯èƒ½æ–­ç½‘ | ä¸èƒ½å› ä¸ºæ—¥å¿—å†™å¤±è´¥å°±å®Œå…¨ä¸èƒ½èŠå¤©ï¼›ä½†åˆè¦å°½é‡ä¿è¯åç«¯"æœ‰ææ–™å¯æ€»ç»“" |

---

## 2. ç³»ç»Ÿæ€»è§ˆï¼ˆç»„ä»¶ä¸è¾¹ç•Œï¼‰

æŠŠç³»ç»Ÿæ‹†æˆå››å—ï¼ˆå¯¹åº”ä»“åº“å››ä¸ªç›®å½•ï¼‰ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Android App (ATRI/)                         â”‚
â”‚                    ğŸ“± UI + æœ¬åœ°å­˜å‚¨ (Room)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ HTTP JSONï¼ˆåŠ  X-App-Tokenï¼‰
                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â˜ï¸ Cloudflare Worker (worker/) â”‚ â”‚   ğŸ–¥ï¸ VPS Server (server/)              â”‚
â”‚  D1 + R2 + Vectorize          â”‚ â”‚   Fastify + PostgreSQL + pgvector      â”‚
â”‚                                â”‚ â”‚   + æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆé™„ä»¶ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ åŸç”Ÿå¤šæ ¼å¼é€‚é…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¸Šæ¸¸æ¨¡å‹ï¼ˆOpenAI / Anthropic / Gemini æ ¼å¼ï¼‰            â”‚
â”‚                   ğŸ¤– Chat / Embeddings API                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¦ 2.1 ç»„ä»¶èŒè´£ä¸€è§ˆ

<table>
<tr>
<th>ç»„ä»¶</th>
<th>ç›®å½•</th>
<th>èŒè´£</th>
</tr>
<tr>
<td>ğŸ“± <strong>Android App</strong></td>
<td><code>ATRI/</code></td>
<td>
â€¢ UI + æœ¬åœ°ä¿å­˜ï¼ˆRoomï¼‰<br/>
â€¢ ä¸Šä¼ é™„ä»¶åˆ°åç«¯<br/>
â€¢ æŠŠ"ç”¨æˆ·æ¶ˆæ¯"å’Œ"äºšæ‰˜è‰å›å¤"éƒ½å†™å…¥åç«¯çš„ <code>conversation_logs</code><br/>
â€¢ æŠŠåç«¯è¿”å›çš„ status/intimacy æ˜¾ç¤ºæˆ"çŠ¶æ€èƒ¶å›Š"
</td>
</tr>
<tr>
<td>ğŸ–¥ï¸ <strong>VPS Server</strong></td>
<td><code>server/</code></td>
<td>
â€¢ <code>/api/v1/chat</code>ï¼šç”Ÿæˆå›å¤ï¼ˆä¸€æ¬¡æ€§ JSONï¼‰<br/>
â€¢ <code>/conversation/*</code>ï¼šå†™/åˆ /æŸ¥/æ‹‰å–å¯¹è¯æ—¥å¿—<br/>
â€¢ <code>/diary/*</code>ï¼šæŸ¥æ—¥è®°/åˆ—æ—¥è®°/æ‰‹åŠ¨é‡ç”Ÿæˆ<br/>
â€¢ <code>/upload</code> & <code>/media*</code>ï¼šé™„ä»¶ä¸Šä¼ ä¸è®¿é—®æ§åˆ¶<br/>
â€¢ <code>/models</code>ï¼šæ‹‰å–ä¸Šæ¸¸æ¨¡å‹åˆ—è¡¨ç»™ App é€‰<br/>
â€¢ <code>/admin/*</code>ï¼šç®¡ç†åå° API + é™æ€é¡µé¢<br/>
â€¢ <code>/v1/chat/completions</code> / <code>/v1/messages</code> / <code>/v1beta/models/*</code>ï¼šå…¼å®¹ API<br/>
â€¢ <strong>Cron</strong>ï¼šæ¯å¤©è‡ªåŠ¨ç”Ÿæˆæ—¥è®°/ç”¨æˆ·æ¡£æ¡ˆï¼Œå¹¶å†™å‘é‡è®°å¿†<br/>
â€¢ <strong>ä¸»åŠ¨æ¶ˆæ¯</strong>ï¼šå®šæ—¶è¯„ä¼°æ˜¯å¦ä¸»åŠ¨è¯´è¯ï¼Œæ”¯æŒ Email/ä¼ä¸šå¾®ä¿¡å¤–éƒ¨é€šçŸ¥<br/>
â€¢ <strong>Memory Rebuild</strong>ï¼šå¯åŠ¨æ—¶å¯é€‰é‡å»ºå‘é‡è®°å¿†
</td>
</tr>
<tr>
<td>â˜ï¸ <strong>Cloudflare Worker</strong></td>
<td><code>worker/</code></td>
<td>
åŠŸèƒ½ä¸ VPS ç‰ˆåŸºæœ¬ä¸€è‡´ï¼Œå·®å¼‚ï¼šä½¿ç”¨ D1ï¼ˆSQLiteï¼‰ä»£æ›¿ PostgreSQLã€R2 ä»£æ›¿æœ¬åœ°æ–‡ä»¶ã€Vectorize ä»£æ›¿ pgvector
</td>
</tr>
<tr>
<td>ğŸ“ <strong>å…±äº«æç¤ºè¯</strong></td>
<td><code>shared/prompts.json</code></td>
<td>
â€¢ äººæ ¼/æ—¥è®°/æ¡£æ¡ˆçš„"æ¯æœ¬"<br/>
â€¢ åç«¯çœŸæ­£è¯»å–çš„æ˜¯å„è‡ªçš„ <code>config/prompts.json</code>ï¼ˆç”±è„šæœ¬åŒæ­¥æˆ–ç›´æ¥å†…ç½®ï¼‰
</td>
</tr>
</table>

---

## 3. æ ¸å¿ƒé“¾è·¯ï¼šä¸€æ¬¡å¯¹è¯åˆ°åº•æ€ä¹ˆèµ°å®Œï¼ˆä»ç‚¹å‘é€å¼€å§‹ï¼‰

è¿™ä¸€èŠ‚æ˜¯æ•´å¥—ç³»ç»Ÿçš„**ä¸»çº¿**ã€‚çœ‹æ‡‚å®ƒï¼Œä½ å°±èƒ½ç†è§£åé¢æ‰€æœ‰è®¾è®¡ã€‚

### ğŸ”„ 3.1 å¯¹è¯é¡ºåºå›¾ï¼ˆç°çŠ¶ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·  â”‚                    â”‚  Android    â”‚                   â”‚   Server   â”‚
â”‚        â”‚                    â”‚    App      â”‚                   â”‚            â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚                                â”‚                                 â”‚
    â”‚  â‘  é€‰æ‹©é™„ä»¶ï¼ˆå¯é€‰ï¼‰              â”‚                                 â”‚
    â”‚  â‘¡ ç‚¹å‡»å‘é€                     â”‚                                 â”‚
    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                                 â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘¢ æœ¬åœ°å…ˆæ’å…¥ messagesï¼ˆRoomï¼‰    â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘£ POST /conversation/log      â”‚
    â”‚                                â”‚    (role=user, å†™å…¥ DB)         â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘¤ POST /api/v1/chat           â”‚
    â”‚                                â”‚    (content + é™„ä»¶ä¿¡æ¯)          â”‚
    â”‚                                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    â”‚                                â”‚         â”‚ â‘¥ é‰´æƒ X-App-Token   â”‚â”‚
    â”‚                                â”‚         â”‚ â‘¦ è¯»ä»Šå¤©+æ˜¨å¤©å¯¹è¯æ—¥å¿— â”‚â”‚
    â”‚                                â”‚         â”‚ â‘§ è¯»ç”¨æˆ·æ¡£æ¡ˆ         â”‚â”‚
    â”‚                                â”‚         â”‚ â‘¨ è¯»å®æ—¶äº‹å®è®°å¿†      â”‚â”‚
    â”‚                                â”‚         â”‚ â‘© è¯» user_states    â”‚â”‚
    â”‚                                â”‚         â”‚ â‘ª ç»„ system prompt   â”‚â”‚
    â”‚                                â”‚         â”‚ â‘« è°ƒå¤§æ¨¡å‹ï¼ˆå·¥å…·å¾ªç¯ï¼‰ â”‚â”‚
    â”‚                                â”‚         â”‚ â‘¬ ä¿å­˜æœ€æ–° user_statesâ”‚â”‚
    â”‚                                â”‚         â”‚ â‘­ ä¿å­˜å›å¤åˆ°å¯¹è¯æ—¥å¿—  â”‚â”‚
    â”‚                                â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘® è¿”å› JSONï¼š                  â”‚
    â”‚                                â”‚     reply + status + intimacy   â”‚
    â”‚                                â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                â”‚                                 â”‚
    â”‚                                â”‚  â‘¯ æ’å…¥å›å¤åˆ° messagesï¼ˆRoomï¼‰   â”‚
    â”‚                                â”‚                                 â”‚
    â”‚  â‘° æ˜¾ç¤ºå›å¤ + çŠ¶æ€èƒ¶å›Š           â”‚                                 â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                                 â”‚
    â”‚                                â”‚                                 â”‚
```

### ğŸ’¡ 3.2 "å…ˆå†™æ—¥å¿—ï¼Œå†èŠå¤©"çš„æ ¸å¿ƒåŠ¨æœº

> **å…³é”®è®¾è®¡ç‚¹**

ä½ ä¼šçœ‹åˆ° App åœ¨è°ƒç”¨ `/api/v1/chat` ä¹‹å‰ï¼Œå…ˆ `POST /conversation/log` å†™ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯åˆ° DBã€‚

<table>
<tr>
<th width="50%">âœ… å¥½å¤„</th>
<th width="50%">âš ï¸ å¸¦æ¥çš„é—®é¢˜</th>
</tr>
<tr>
<td>
â€¢ Server æ„é€ ä¸Šä¸‹æ–‡æ—¶ï¼Œä¸ç”¨ä¿¡ä»»å®¢æˆ·ç«¯"ç»™æˆ‘æœ€è¿‘ N æ¡æ¶ˆæ¯"ï¼Œè€Œæ˜¯ç›´æ¥è¯» DB çš„å¯¹è¯æ—¥å¿—<br/>
â€¢ æ—¥è®°/æ¡£æ¡ˆ/å‘é‡è®°å¿†éƒ½èƒ½ä»¥ DB ä¸ºææ–™ï¼Œé“¾è·¯ç»Ÿä¸€
</td>
<td>
Server è¯»"ä»Šå¤©èŠå¤©è®°å½•"æ—¶ï¼Œå¯èƒ½æŠŠåˆšå†™å…¥çš„è¿™ä¸€æ¡ä¹Ÿè¯»åˆ°å†å²é‡Œï¼Œå¯¼è‡´æ¨¡å‹çœ‹åˆ°é‡å¤å†…å®¹
</td>
</tr>
</table>

**è§£å†³æ–¹æ¡ˆ**ï¼šApp ä¼šæŠŠè¿™æ¡ç”¨æˆ·æ¶ˆæ¯çš„ id ä½œä¸º `logId` ä¼ ç»™ `/api/v1/chat`ï¼ŒServer è¯»å†å²æ—¶ä¼šå‰”é™¤å®ƒï¼ˆè§ [`server/src/services/agent-service.ts`](server/src/services/agent-service.ts) çš„ `excludeLogId`ï¼‰ã€‚

> ğŸ“Œ **ä¸€å¥è¯æ€»ç»“**ï¼š**DB æ˜¯"èŠå¤©äº‹å®æº"ï¼ŒlogId æ˜¯"å»é‡å¼€å…³"ã€‚**

### ğŸ­ 3.3 ä¸ºä»€ä¹ˆæ—¥å¿—å†™å¤±è´¥ä¹Ÿä¸é˜»å¡èŠå¤©

[`ChatRepository.logConversationSafely(...)`](ATRI/app/src/main/java/me/atri/data/repository/ChatRepository.kt) æ˜¯ `runCatching` åŒ…èµ·æ¥çš„ï¼šå†™æ—¥å¿—å¤±è´¥ä¼šæ‰“å°ï¼Œä½†ä¸ä¼šè®© UI å¡æ­»ã€‚

| å–èˆ | è¯´æ˜ |
|------|------|
| âœ… ç”¨æˆ·ä½“éªŒä¼˜å…ˆ | æ–­ç½‘/è¶…æ—¶ä¹Ÿè¦å°½é‡èƒ½ç»§ç»­èŠï¼ˆè‡³å°‘èƒ½æ‹¿åˆ°å›å¤ï¼‰ |
| âš ï¸ ä»£ä»· | é‚£ä¸€å¤©çš„ DB ææ–™å¯èƒ½ä¸å®Œæ•´ï¼Œä¼šå½±å“æ—¥è®°/è®°å¿†è´¨é‡ |

### ğŸ”„ 3.4 ä¸¤å¤©ä¸Šä¸‹æ–‡çª—å£

Server åœ¨æ„é€ èŠå¤©ä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šåŠ è½½**ä»Šå¤© + æ˜¨å¤©**ä¸¤å¤©çš„å¯¹è¯æ—¥å¿—ä½œä¸ºå†å²ï¼ˆè§ [`server/src/services/history-context.ts`](server/src/services/history-context.ts) çš„ `loadTwoDaysConversationLogs`ï¼‰ã€‚è¿™è®©æ¨¡å‹èƒ½è‡ªç„¶åœ°å»¶ç»­è·¨å¤©è¯é¢˜ï¼ŒåŒæ—¶æ§åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ã€‚

> ğŸ“Œ è¿™ä¸ªé€»è¾‘å·²æŠ½å–ä¸ºç‹¬ç«‹æ¨¡å— `history-context.ts`ï¼Œè¢«ä¸»å¯¹è¯ï¼ˆ`agent-service.ts`ï¼‰å’Œä¸»åŠ¨æ¶ˆæ¯ï¼ˆ`proactive-service.ts`ï¼‰å…±ç”¨ï¼Œä¿è¯ä¸¤è€…çœ‹åˆ°çš„ä¸Šä¸‹æ–‡å®Œå…¨ä¸€è‡´ã€‚

---

## 4. åˆ›æ–°ç‚¹ 1ï¼šçŠ¶æ€èƒ¶å›Š + äº²å¯†åº¦è¡°å‡ï¼ˆè®©æƒ…ç»ªæœ‰è§†è§‰è¡¨è¾¾ï¼Œå…³ç³»æœ‰æƒ¯æ€§ï¼‰

### ğŸ¨ 4.1 çŠ¶æ€èƒ¶å›Šæ˜¯ä»€ä¹ˆ

**çŠ¶æ€èƒ¶å›Šï¼ˆStatus Capsuleï¼‰** æ˜¯ ATRI çš„åŠ¨æ€å¿ƒæƒ…/çŠ¶æ€æ˜¾ç¤ºç³»ç»Ÿã€‚å®ƒä¸æ˜¯ä¼ ç»Ÿçš„ä¸‰ç»´æƒ…ç»ªåæ ‡ï¼Œè€Œæ˜¯**æ¨¡å‹è‡ªä¸»é€‰æ‹©çš„æ–‡æ¡ˆ + é¢œè‰²**ï¼Œç”¨äºåœ¨ App ç«¯å±•ç¤ºä¸ºä¸€ä¸ªå°èƒ¶å›Šæ ‡ç­¾ã€‚

| å­—æ®µ | å«ä¹‰ | ç¤ºä¾‹ |
|:----:|------|------|
| `status_label` | çŠ¶æ€æ–‡æ¡ˆï¼ˆä¸­æ–‡çŸ­å¥ï¼‰ | `é™ªç€ä½ `ã€`æœ‰ç‚¹æƒ³ä½ äº†`ã€`å›°äº†â€¦` |
| `status_pill_color` | èƒ¶å›Šåº•è‰²ï¼ˆHEXï¼‰ | `#E3F2FD`ï¼ˆATRI æ°”æ³¡è‰²ï¼‰ã€`#7FA8FF`ã€`#FF9A9E` |
| `status_text_color` | èƒ¶å›Šæ–‡å­—é¢œè‰²ï¼ˆHEXï¼‰ | `#FFFFFF` |
| `status_reason` | åªè¯´ç»™è‡ªå·±å¬çš„åŸå›  | `èŠå¾—å¾ˆå¼€å¿ƒï¼Œæƒ³å¤šå¾…ä¸€ä¼šå„¿` |

> ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼šä¸ç”¨æŠ½è±¡çš„ä¸‰ç»´æ•°å€¼ï¼ˆPADï¼‰æ¥è¡¨è¾¾æƒ…ç»ªï¼Œè€Œæ˜¯è®©æ¨¡å‹ç”¨è‡ªç„¶è¯­è¨€ + é¢œè‰²ç›´æ¥è¡¨è¾¾"æˆ‘ç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€"ï¼Œæ›´ç›´è§‚ã€æ›´æœ‰è¡¨ç°åŠ›ã€‚

### ğŸ’• 4.2 äº²å¯†åº¦æ˜¯ä»€ä¹ˆ

åç«¯è¿˜ç»´æŠ¤ä¸€ä¸ª `intimacy`ï¼ˆèŒƒå›´ `-100` ~ `100`ï¼‰ï¼Œä»£è¡¨"å…³ç³»æ¸©åº¦"ã€‚

> âš ï¸ å®ƒä¸æ˜¯ UI çš„è£…é¥°ï¼Œè€Œæ˜¯ä¼šè¿› promptï¼Œè®©å›å¤é£æ ¼éšç€å…³ç³»å˜åŒ–ã€‚

### ğŸ—ƒï¸ 4.3 æ•°æ®è½åœ¨å“ª

åœ¨ **`user_states`** è¡¨ï¼ˆPostgreSQL / D1ï¼‰ï¼š

```sql
user_id              -- ç”¨æˆ· id
status_label         -- çŠ¶æ€æ–‡æ¡ˆ
status_pill_color    -- èƒ¶å›Šåº•è‰² HEX
status_text_color    -- èƒ¶å›Šæ–‡å­—é¢œè‰² HEX
status_reason        -- çŠ¶æ€åŸå› ï¼ˆå†…éƒ¨ï¼‰
status_updated_at    -- çŠ¶æ€æ›´æ–°æ—¶é—´
intimacy             -- å…³ç³»æ¸©åº¦æ•´æ•°
last_interaction_at / updated_at  -- æ—¶é—´æˆ³
```

### ğŸ”§ 4.4 æ›´æ–°æœºåˆ¶ï¼ˆæ¨¡å‹"ç”³è¯·ä¿®æ”¹"ï¼‰

Server ç»™æ¨¡å‹æ³¨å†Œäº†ä¸¤ä¸ªå·¥å…·ï¼ˆè§ [`server/src/services/agent-service.ts`](server/src/services/agent-service.ts) çš„ `AGENT_TOOLS`ï¼‰ï¼š

```typescript
set_status(label, pill_color, text_color?, reason)
update_intimacy(delta, reason)
```

> ğŸ’¡ **è®¾è®¡æ„å›¾**ï¼šå½“æ¨¡å‹åˆ¤æ–­"å¿ƒæƒ…/çŠ¶æ€åº”è¯¥å˜åŒ–"æ—¶ï¼Œå…ˆé€šè¿‡ `set_status` æ›´æ–°æ–‡æ¡ˆå’Œé¢œè‰²ï¼Œå†å›ç­”ã€‚äº²å¯†åº¦å˜åŒ–åˆ™é€šè¿‡ `update_intimacy` ç”³è¯·ã€‚

<details>
<summary>ğŸ“ å¦‚ä½•è®©æ¨¡å‹æ›´ç§¯æåœ°è°ƒç”¨è¿™äº›å·¥å…·ï¼Ÿ</summary>

å½“å‰ system prompt æ¨¡æ¿é‡Œå·²ç»å†™äº†æ˜ç¡®è§„åˆ™ï¼š

```
å½“ä½ è§‰å¾—çŠ¶æ€å˜åŒ–äº†ï¼Œå…ˆè°ƒç”¨ set_status å·¥å…·æ›´æ–°æ–‡æ¡ˆå’Œé¢œè‰²ï¼Œå†ç»§ç»­å›å¤ã€‚
```

å¦‚æœä½ å‘ç°æ¨¡å‹å¾ˆå°‘è°ƒç”¨ï¼Œå¯ä»¥åœ¨ `shared/prompts.json` çš„ `agent.system` é‡ŒåŠ å¼ºæŒ‡ç¤ºã€‚è¿™æ¯”"åç«¯å†™ä¸€å † if/else è§„åˆ™"æ›´å¯æ‰©å±•ï¼šä½ æ¢äººæ ¼/æ¢æ¨¡å‹/æ¢æç¤ºè¯æ—¶ï¼Œä¸éœ€è¦é‡å†™è§„åˆ™å¼•æ“ã€‚

</details>

### ğŸ“‰ 4.5 è¡°å‡æœºåˆ¶

<table>
<tr>
<th>è¡°å‡ç±»å‹</th>
<th>è§„åˆ™</th>
<th>å«ä¹‰</th>
</tr>
<tr>
<td><strong>äº²å¯†åº¦è¡°å‡</strong></td>
<td>
æ¯éš” 3 å¤©ï¼ŒæŠŠäº²å¯†åº¦å¾€ 0 æ¨ 1 ç‚¹ï¼ˆæ­£æ•°å˜å°ï¼Œè´Ÿæ•°å˜å¤§ï¼‰
</td>
<td>ğŸ’” å…³ç³»ä¸ç»´æŠ¤ä¼šæ…¢æ…¢æ·¡</td>
</tr>
<tr>
<td><strong>é¢å¤–çº¦æŸ</strong></td>
<td>
â€¢ <code>update_intimacy</code> çš„ delta è¢« clamp åˆ° <code>[-50, 10]</code><br/>
â€¢ å¦‚æœå½“å‰äº²å¯†åº¦ < 0ï¼Œæƒ³å‡æ¸©ä¼šæ‰“æŠ˜ï¼ˆ<code>*0.6</code>ï¼Œè‡³å°‘ +1ï¼‰
</td>
<td>ğŸ’” "ç ´é•œéš¾åœ†"çš„å·¥ç¨‹åŒ–è¡¨è¾¾</td>
</tr>
</table>

### ğŸ¯ 4.6 å®ƒæ€ä¹ˆå½±å“å›å¤

[`composeAgentSystemPrompt(...)`](server/src/services/agent-service.ts) ä¼šæŠŠçŠ¶æ€èƒ¶å›Šä¿¡æ¯å’Œäº²å¯†åº¦å†™è¿› system promptï¼ˆæ¥è‡ª `shared/prompts.json` çš„ `agent.system` æ¨¡æ¿æˆ–å†…ç½®é»˜è®¤æ¨¡æ¿ï¼‰ã€‚

> ğŸ“Œ æ‰€ä»¥æ¨¡å‹æ¯æ¬¡å›å¤éƒ½å¸¦ç€"æˆ‘ç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€ã€å’Œä½ æ˜¯ä»€ä¹ˆå…³ç³»"ã€‚

Server è¿”å›ç»™ App çš„ `status` å¯¹è±¡ï¼ˆåŒ…å« label/pillColor/textColorï¼‰å’Œ `intimacy`ï¼Œç”¨äº UI å±•ç¤ºçŠ¶æ€èƒ¶å›Šã€‚

---

## 5. åˆ›æ–°ç‚¹ 2ï¼šæ—¥è®° highlights å‘é‡è®°å¿†ï¼ˆç”¨"æç‚¼è¿‡çš„è®°å¿†"å»åšæ£€ç´¢ï¼‰

> ğŸ’¡ å¾ˆå¤š RAG çš„å‘æ¥è‡ªä¸€å¥è¯ï¼š**æŠŠå™ªå£°ä¹Ÿå‘é‡åŒ–äº†**ã€‚

æˆ‘è¿™é‡Œåˆ»æ„ä¸åš"æ¯å¥å¯¹è¯éƒ½è¿›å‘é‡åº“"ï¼Œè€Œæ˜¯ï¼š

```
â‘  å…ˆæ¯å¤©ç”Ÿæˆä¸€ç¯‡æ—¥è®°ï¼ˆå¸¦ highlightsï¼‰
           â†“
â‘¡ åªæŠŠ highlightsï¼ˆ4~10 æ¡çŸ­å¥ï¼‰å‘é‡åŒ–
           â†“
â‘¢ æ£€ç´¢æ—¶å…ˆå¬å›"å“ªå¤©å‘ç”Ÿè¿‡ä»€ä¹ˆ"ï¼Œå†æŒ‰éœ€è¯»æ—¥è®°/åŸæ–‡
```

### âœ¨ 5.1 ä¸ºä»€ä¹ˆ highlights æ¯”é€å¥å¯¹è¯æ›´é€‚åˆå‘é‡åŒ–

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| ğŸ¯ **ä¿¡æ¯å¯†åº¦é«˜** | highlights æ˜¯"äº‹ä»¶ + å¯¹è±¡ + æƒ…ç»ª"çš„çŸ­å¥ï¼Œä¸æ˜¯é—²èŠå£æ°´ |
| ğŸ’° **æˆæœ¬å¯æ§** | æ¯å¤©æœ€å¤š 10 æ¡å‘é‡ï¼Œè€Œä¸æ˜¯ä¸Šåƒæ¡ |
| ğŸ² **å¬å›æ›´ç¨³** | æŒ‰"å¤©"å»é‡ï¼Œæ›´åƒäººç±»å›å¿†è·¯å¾„ï¼ˆå…ˆæƒ³èµ·é‚£å¤©ï¼Œå†çœ‹ç»†èŠ‚ï¼‰ |

### ğŸ“ 5.2 å‘é‡å†™å…¥

**VPS ç‰ˆ**ä½¿ç”¨ PostgreSQL + pgvector æ‰©å±•ï¼Œå‘é‡ç›´æ¥å­˜å‚¨åœ¨ `memory_vectors` è¡¨ä¸­ã€‚

å†™å…¥é€»è¾‘åœ¨ [`server/src/services/memory-service.ts`](server/src/services/memory-service.ts) çš„ `upsertDiaryHighlightsMemory`ï¼š

```typescript
// å‘é‡ ID è§„åˆ™
id: `hl:<userId>:<date>:<i>`  // i ä» 0 å¼€å§‹ï¼Œæœ€å¤š 10

// è¡¨å­—æ®µ
{
  id,
  user_id,
  date,          // æ—¥æœŸ YYYY-MM-DD
  idx,           // åºå·
  text,          // highlight åŸæ–‡
  mood,          // æƒ…ç»ª
  importance: 6, // é‡è¦åº¦ï¼ˆå½“å‰å›ºå®š 6ï¼‰
  timestamp,     // å†™å…¥æ—¶é—´æˆ³
  embedding      // vector(1024) å‘é‡
}
```

> ğŸ“Œ **Cloudflare Worker ç‰ˆ**ä½¿ç”¨ Vectorize å­˜å‚¨å‘é‡ï¼Œå‘é‡ ID å’Œ metadata ç»“æ„ä¸ä¸Šè¿°ç±»ä¼¼ã€‚

### ğŸ” 5.3 å‘é‡æ£€ç´¢ï¼ˆsearch_memory å·¥å…·ï¼‰

æ¨¡å‹æƒ³å›å¿†æ—¶ï¼Œä¸æ˜¯åç«¯å¼ºè¡ŒæŠŠä¸€å †è®°å¿†å¡è¿› promptï¼Œè€Œæ˜¯è®©æ¨¡å‹è‡ªå·±è°ƒç”¨ï¼š

```typescript
search_memory(query)
```

**å®ç°æµç¨‹**ï¼ˆ[`server/src/services/memory-service.ts`](server/src/services/memory-service.ts)ï¼‰ï¼š

```
â‘  å¯¹ query åš embeddingï¼ˆè°ƒ Embeddings APIï¼‰
           â†“
â‘¡ PostgreSQL ä½™å¼¦è·ç¦»æŸ¥è¯¢ï¼ˆembedding <=> vectorï¼‰ï¼ŒLIMIT topK
           â†“
â‘¢ è¿‡æ»¤ï¼šåªä¿ç•™ user_id åŒ¹é…çš„
           â†“
â‘£ è¿”å›æŒ‰ç›¸ä¼¼åº¦æ’åºçš„"ç‰‡æ®µ"ï¼ˆæ—¥æœŸ + åŸæ–‡ + åˆ†æ•°ï¼‰
```

### ğŸ”— 5.4 å›å¿†åˆ†ä¸¤æ®µï¼šå…ˆæ‰¾æ—¥æœŸï¼Œå†è¯»åŸæ–‡

> ğŸš« **é˜²ä¹±ç¼–çš„å…³é”®è®¾è®¡**

å·¥å…·é“¾åœ¨ [`server/src/services/agent-service.ts`](server/src/services/agent-service.ts)ï¼š

| æ­¥éª¤ | å·¥å…· | ä½œç”¨ |
|:----:|------|------|
| 1ï¸âƒ£ | `search_memory(query)` | å‘Šè¯‰æ¨¡å‹"å¯èƒ½ç›¸å…³çš„æ˜¯å“ªå‡ å¤© + ä¸€å¥ç‰‡æ®µ" |
| 2ï¸âƒ£ | `read_diary(date)` | è¯»é‚£å¤©æ—¥è®°ï¼ˆç¬¬ä¸€äººç§°ã€æƒ…ç»ªæ›´æµ“ï¼‰ |
| 2ï¸âƒ£ | `read_conversation(date)` | è¯»é‚£å¤©åŸå§‹èŠå¤©ï¼ˆå¸¦æ—¶é—´æˆ³ï¼Œé€‚åˆå¼•ç”¨åŸè¯ï¼‰ |

> ğŸ“Œ è¿™å°±æ˜¯**"å·¥å…·æ³¨å†Œå–ä»£å…¨é‡æ³¨å…¥"**çš„æ ¸å¿ƒï¼šä¸æŠŠæ‰€æœ‰å†å²å¡è¿›å»ï¼Œåªåœ¨éœ€è¦æ—¶å–è¯ã€‚

---

## 6. åˆ›æ–°ç‚¹ 3ï¼šæ—¥è®°/ç”¨æˆ·æ¡£æ¡ˆ/å®æ—¶äº‹å®ï¼ˆåˆ†æµä¸Šæ¸¸ + ä¸‰ä¸ªäº§ç‰©ä¸‰ç§ç”¨é€”ï¼‰

### ğŸ“Š 6.1 ä¸‰ä¸ªäº§ç‰©åˆ†åˆ«è§£å†³ä»€ä¹ˆ

<table>
<tr>
<th width="15%">äº§ç‰©</th>
<th width="20%">å­˜å‚¨ä½ç½®</th>
<th width="30%">è§£å†³ä»€ä¹ˆ</th>
<th width="35%">ç»™æ¨¡å‹ä»€ä¹ˆ</th>
</tr>
<tr>
<td>ğŸ“” <strong>æ—¥è®°</strong></td>
<td><code>diary_entries</code></td>
<td>æŠŠ"ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆ + æˆ‘æ€ä¹ˆæƒ³"å†™æˆå¯è¯»å™äº‹</td>
<td>æƒ…æ„Ÿè¿ç»­æ€§ + highlightsï¼ˆç”¨äºå‘é‡ï¼‰</td>
</tr>
<tr>
<td>ğŸ“‹ <strong>ç”¨æˆ·æ¡£æ¡ˆ</strong></td>
<td><code>user_profiles</code></td>
<td>æŠŠ"äº‹å®/å–œå¥½/é›·åŒº/è¯´è¯é£æ ¼/å…³ç³»è¿›å±•"åšæˆç»“æ„åŒ–æ‘˜è¦</td>
<td>é•¿æœŸç¨³å®šã€ä½å™ªå£°ï¼ˆè¿› system promptï¼‰</td>
</tr>
<tr>
<td>ğŸ§  <strong>å®æ—¶äº‹å®è®°å¿†</strong></td>
<td><code>memory_vectors</code><br/>(mood=system_fact)</td>
<td>æ¨¡å‹åœ¨èŠå¤©ä¸­éšæ—¶è®°ä½/å¿˜è®°çš„å…·ä½“äº‹å®</td>
<td>çŸ­æœŸåˆ°é•¿æœŸçš„ç²¾ç¡®è®°å¿†ï¼ˆè¿› system promptï¼‰</td>
</tr>
</table>

> ğŸ’¡ è¿™ä¸‰ä¸ªä¸œè¥¿éƒ½ä¸æ˜¯"ä¸ºäº†å¥½çœ‹"ï¼Œè€Œæ˜¯ç»™æ¨¡å‹ä¸‹æ¬¡å¯¹è¯æä¾›**ä¸åŒå±‚æ¬¡çš„ææ–™**ã€‚

### ğŸ†• 6.2 å®æ—¶äº‹å®è®°å¿†ï¼ˆ`remember_fact` / `forget_fact`ï¼‰

è¿™æ˜¯å¯¹æ—©æœŸ"äºšæ‰˜è‰ä¾¿ç­¾"ï¼ˆ`atri_self_reviews`ï¼‰çš„é‡å¤§å‡çº§ã€‚æ¨¡å‹ç°åœ¨å¯ä»¥åœ¨èŠå¤©è¿‡ç¨‹ä¸­**å®æ—¶**è®°ä½æˆ–å¿˜è®°å…·ä½“äº‹å®ï¼š

```typescript
remember_fact(content)  // "å¯¹æ–¹ä¸‹å‘¨äºŒè¦è€ƒè¯•"
forget_fact(factId)     // åˆ é™¤è¿‡æ—¶çš„äº‹å®
```

**å­˜å‚¨æœºåˆ¶**ï¼š
- äº‹å®ä»¥å‘é‡å½¢å¼å­˜å‚¨åœ¨ `memory_vectors` è¡¨ä¸­ï¼ˆ`mood = 'system_fact'`ï¼‰
- ID æ ¼å¼ï¼š`fact:<userId>:<md5_hash>`ï¼Œç”¨ MD5 å“ˆå¸Œå»é‡
- é‡è¦åº¦å›ºå®šä¸º 10ï¼ˆé«˜äºæ—¥è®° highlights çš„ 6ï¼‰ï¼Œç¡®ä¿äº‹å®åœ¨å‘é‡æ£€ç´¢ä¸­ä¼˜å…ˆ
- æ¯æ¬¡å¯¹è¯å¼€å§‹æ—¶ï¼Œæœ€è¿‘ 15 æ¡æ´»è·ƒäº‹å®ä¼šè¢«åŠ è½½åˆ° system prompt

### ğŸ”„ 6.3 ç”Ÿæˆé“¾è·¯

#### Cronï¼ˆæ¯å¤©è‡ªåŠ¨è·‘ï¼‰

åœ¨ [`server/src/jobs/diary-cron.ts`](server/src/jobs/diary-cron.ts)ï¼Œç”± [`server/src/jobs/diary-scheduler.ts`](server/src/jobs/diary-scheduler.ts) è°ƒåº¦ï¼š

```
â‘  æ‰¾å‡º"ä»Šå¤©æœ‰èŠå¤©ä½†è¿˜æ²¡ ready æ—¥è®°"çš„ç”¨æˆ·
                    â†“
â‘¡ æ‹‰å½“å¤© conversation_logs â†’ æ‹¼ transcript
                    â†“
â‘¢ ç”Ÿæˆæ—¥è®°ï¼ˆgenerateDiaryFromConversationï¼‰
                    â†“
â‘£ ä¿å­˜æ—¥è®°åˆ° diary_entriesï¼ˆstatus=readyï¼‰
                    â†“
â‘¤ highlights å‘é‡åŒ–å†™å…¥ memory_vectorsï¼ˆpgvectorï¼‰
                    â†“
â‘¥ åˆ·æ–° user_profilesï¼ˆç»“æ„åŒ–æ¡£æ¡ˆï¼‰
```

**è°ƒåº¦å™¨ç‰¹æ€§**ï¼š
- å¯é…ç½®è§¦å‘æ—¶é—´ï¼ˆ`DIARY_CRON_TIME`ï¼Œé»˜è®¤ 23:59ï¼‰å’Œæ—¶åŒºï¼ˆ`DIARY_CRON_TIMEZONE`ï¼‰
- æ”¯æŒ catchup æœºåˆ¶ï¼ˆ`DIARY_CRON_CATCHUP_DAYS`ï¼Œé»˜è®¤ 2 å¤©ï¼‰ï¼Œè‡ªåŠ¨è¡¥ç”Ÿæˆé—æ¼çš„æ—¥è®°
- ä½¿ç”¨ PostgreSQL advisory lock é˜²æ­¢å¹¶å‘æ‰§è¡Œ

#### æ‰‹åŠ¨é‡ç”Ÿæˆ

`POST /diary/regenerate` ä¼šé‡æ–°ç”Ÿæˆå½“å¤©æ—¥è®°ï¼Œå¹¶ä¸”**å¼ºåˆ¶åˆ·æ–°æ¡£æ¡ˆ**ï¼ˆä¿è¯ä¸¤è€…ä¸€è‡´ï¼‰ã€‚

### ğŸ”€ 6.4 åˆ†æµä¸Šæ¸¸

> âš ï¸ **é‡è¦ï¼šèŠå¤©åˆ«è¢«æ—¥è®°æ‹–æ­»**

| ç”¨é€” | é…ç½®å˜é‡ | è¯´æ˜ |
|------|----------|------|
| ğŸ’¬ Chat | `OPENAI_API_URL` / `OPENAI_API_KEY` | èŠå¤©èµ°è¿™ä¸ª |
| ğŸ“” æ—¥è®°/æ¡£æ¡ˆ | `DIARY_API_URL` / `DIARY_API_KEY` / `DIARY_MODEL` | å…è®¸èµ°ç‹¬ç«‹ä¸Šæ¸¸ |

**éš”ç¦»çš„æ„ä¹‰**ï¼š
- èŠå¤©è¦å¿«ã€ç¨³å®š
- æ—¥è®°å…è®¸æ…¢ä¸€ç‚¹ã€è´¨é‡é«˜ä¸€ç‚¹ã€ç”šè‡³ç”¨å¦ä¸€å®¶æœåŠ¡
- æ—¥è®°ä¸Šæ¸¸æŒ‚äº†ï¼Œä¸å½±å“èŠå¤©ï¼ˆæœ€å¤šå½“å¤©æ—¥è®°ç”Ÿæˆå¤±è´¥ï¼‰

**å®ç°ä½ç½®**ï¼š
| åŠŸèƒ½ | æ–‡ä»¶ |
|------|------|
| æ—¥è®° | [`server/src/services/diary-generator.ts`](server/src/services/diary-generator.ts) |
| æ¡£æ¡ˆ | [`server/src/services/profile-generator.ts`](server/src/services/profile-generator.ts) |
| ç»Ÿä¸€ LLM è°ƒç”¨ | [`server/src/services/llm-service.ts`](server/src/services/llm-service.ts)ï¼ˆæ”¯æŒ OpenAI/Anthropic/Gemini ä¸‰ç§æ ¼å¼ï¼‰ |

### ğŸ¤– 6.5 æ¨¡å‹é€‰æ‹©ç­–ç•¥ï¼ˆç°çŠ¶ï¼‰

```
èŠå¤©ï¼šä¼˜å…ˆç”¨å®¢æˆ·ç«¯ä¼ æ¥çš„ modelKeyï¼Œå¦åˆ™ç”¨ runtime settings çš„ defaultChatModel
          â†“
åç«¯ä¼šæŠŠ modelKey è®°åˆ° user_settings.model_key
          â†“
Cron ä¼šå¤ç”¨å®ƒä½œä¸ºæ—¥è®°/æ¡£æ¡ˆçš„ modelKey
```

> ğŸ“Œ ä¹Ÿå°±æ˜¯è¯´ï¼š**ç”¨æˆ·é€‰ä»€ä¹ˆæ¨¡å‹ï¼Œæ—¥è®°/æ¡£æ¡ˆä¹Ÿä¼šå°½é‡ç”¨åŒä¸€ä¸ªæ¨¡å‹**ï¼ˆé™¤éä½ åœ¨ç¯å¢ƒé‡Œå¼ºåˆ¶é…ç½®åˆ«çš„ç­–ç•¥ï¼‰ã€‚

---

## 7. åˆ›æ–°ç‚¹ 4ï¼šå·¥å…·æ³¨å†Œå–ä»£å…¨é‡æ³¨å…¥ï¼ˆæŠŠ"æŸ¥è¯"å˜æˆæ¨¡å‹èƒ½åŠ›çš„ä¸€éƒ¨åˆ†ï¼‰

> ğŸš« å¾ˆå¤šç³»ç»Ÿçš„åšæ³•æ˜¯ï¼šæŠŠæ‰€æœ‰å†å²ã€æ‰€æœ‰è®°å¿†ã€æ‰€æœ‰æ¡£æ¡ˆæ‹¼æˆä¸€ä¸ªå·¨å¤§ promptã€‚

**è¿™æ ·åšçš„é—®é¢˜**ï¼š
- ğŸ’° è´¹ç”¨é«˜ã€é€Ÿåº¦æ…¢
- ğŸ”Š å™ªå£°å¤§ã€æ¨¡å‹æ›´å®¹æ˜“"é¡ºç€å™ªå£°ç¼–"
- ğŸ”§ è®°å¿†æ›´æ–°/åˆ é™¤å¾ˆéš¾æ§

**æˆ‘è¿™é‡Œçš„åšæ³•**ï¼š

```
â‘  system prompt åªæ”¾"å½“å‰çŠ¶æ€ + ä½¿ç”¨è§„åˆ™ + æ¡£æ¡ˆ/äº‹å®çš„æ‘˜è¦"
                    â†“
â‘¡ æŠŠ"å›å¿†/æŸ¥è¯/æ›´æ–°çŠ¶æ€/è”ç½‘æœç´¢/è®°ä½äº‹å®"åšæˆå·¥å…·
                    â†“
â‘¢ æ˜ç¡®å‘Šè¯‰æ¨¡å‹ï¼šä»€ä¹ˆæ—¶å€™è¯¥ç”¨ä»€ä¹ˆå·¥å…·ï¼ˆå†™åœ¨ prompts é‡Œï¼‰
```

### ğŸ”§ 7.1 å½“å‰å·²æ³¨å†Œçš„ 8 ä¸ªå·¥å…·

åœ¨ [`server/src/services/agent-service.ts`](server/src/services/agent-service.ts)ï¼š

| å·¥å…· | å‚æ•° | ä½œç”¨ |
|------|------|------|
| `search_memory` | `query` | æ‰¾å¯èƒ½ç›¸å…³çš„æ—¥æœŸ/ç‰‡æ®µï¼ˆæ¥è‡ª highlights + facts å‘é‡ï¼‰ |
| `read_diary` | `date` | è¯»é‚£å¤©æ—¥è®°ï¼ˆç¬¬ä¸€äººç§°ï¼‰ |
| `read_conversation` | `date` | è¯»é‚£å¤©åŸæ–‡èŠå¤©ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰ |
| `web_search` | `query` | è”ç½‘æœç´¢ï¼ˆTavily APIï¼‰ï¼Œç¡®è®¤ä¸ç¡®å®šçš„äº‹å® |
| `set_status` | `label`, `pill_color`, `text_color?`, `reason` | æ›´æ–°çŠ¶æ€èƒ¶å›Šï¼ˆæ–‡æ¡ˆ + é¢œè‰²ï¼‰ |
| `update_intimacy` | `delta`, `reason` | æ›´æ–°å…³ç³»æ¸©åº¦ |
| `remember_fact` | `content` | è®°ä½ä¸€ä¸ªå…·ä½“äº‹å®ï¼ˆå®æ—¶å‘é‡åŒ–å­˜å‚¨ï¼‰ |
| `forget_fact` | `factId` | å¿˜æ‰ä¸€ä¸ªè¿‡æ—¶çš„äº‹å® |

### ğŸ”„ 7.2 å·¥å…·å¾ªç¯æ€ä¹ˆè·‘ï¼ˆæœ€å¤š 5 è½®ï¼‰

`runToolLoop(...)` åšçš„äº‹ï¼š

```
â‘  è°ƒä¸Šæ¸¸ Chat APIï¼ˆå¸¦ tools + tool_choice=autoï¼‰
                    â†“
â‘¡ å¦‚æœæ¨¡å‹è¿”å› tool_callsï¼šé€ä¸ªæ‰§è¡Œï¼Œç»“æœä½œä¸º role=tool å¡å› messages
                    â†“
â‘¢ ã€å…³é”®ã€‘æ‰§è¡Œå®Œå·¥å…·åï¼Œä¼šç”¨æœ€æ–°çŠ¶æ€é‡å»º system prompt
                    â†“
â‘£ ç»§ç»­ä¸‹ä¸€è½®ï¼Œç›´åˆ°æ¨¡å‹ä¸å†è°ƒç”¨å·¥å…·ï¼Œç»™å‡ºæœ€ç»ˆå›å¤
```

> ğŸ“Œ è¿™ä¿è¯ï¼šæ¨¡å‹"å…ˆæ›´æ–°çŠ¶æ€/äº²å¯†åº¦"ï¼Œä¸‹ä¸€å¥å›å¤å°±èƒ½ä½“ç°å˜åŒ–ï¼Œä¸ä¼šå»¶è¿Ÿä¸€è½®ã€‚

### ğŸŒ 7.3 åŸç”Ÿå¤šæ ¼å¼æ”¯æŒ

[`server/src/services/llm-service.ts`](server/src/services/llm-service.ts) å®ç°äº†å¯¹ä¸‰ç§ API æ ¼å¼çš„åŸç”Ÿæ”¯æŒï¼š

| æ ¼å¼ | ç«¯ç‚¹ | æ¶ˆæ¯è½¬æ¢ | å·¥å…·è½¬æ¢ |
|------|------|----------|----------|
| **OpenAI** | `/v1/chat/completions` | åŸç”Ÿï¼ˆæ— éœ€è½¬æ¢ï¼‰ | åŸç”Ÿ |
| **Anthropic** | `/v1/messages` | `openAiMessagesToAnthropic` | `openAiToolsToAnthropic` |
| **Gemini** | `/v1beta/models/:model:generateContent` | `openAiMessagesToGemini` | `openAiToolsToGemini` |

å†…éƒ¨ç»Ÿä¸€ä½¿ç”¨ OpenAI æ ¼å¼çš„ messages/tools æ•°æ®ç»“æ„ï¼Œåœ¨å‘é€è¯·æ±‚æ—¶æŒ‰ `chatApiFormat` é…ç½®è‡ªåŠ¨è½¬æ¢ã€‚å“åº”ä¹Ÿä¼šç»Ÿä¸€æå–å› OpenAI æ ¼å¼çš„ `{ content, tool_calls }`ã€‚

---

## 8. é™„ä»¶ä¸åª’ä½“è®¿é—®æ§åˆ¶ï¼ˆç»™ App çš„é•¿é“¾æ¥ï¼Œç»™æ¨¡å‹çš„ç¨³é“¾æ¥ï¼‰

### ğŸ“¤ 8.1 ä¸Šä¼ ï¼ˆ`POST /upload`ï¼‰

åœ¨ [`server/src/routes/media.ts`](server/src/routes/media.ts)ï¼š

```typescript
// App ä¸Šä¼ æ—¶çš„ Header
X-File-Name / X-File-Type / X-File-Size / X-User-Id

// body æ˜¯æ–‡ä»¶å­—èŠ‚æµ

// Server å­˜åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆMEDIA_ROOTï¼‰ï¼Œkey å½¢å¦‚ï¼š
`u/<safeUserId>/<timestamp>-<safeFileName>`
```

**è¿”å›å€¼**ï¼š

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `key` | å­˜å‚¨ key |
| `rawUrl` | ä¸ç­¾åçš„ `/media/<key>` |
| `url` | ç»™ App çš„é•¿ç­¾å URLï¼ˆé»˜è®¤ 1 å¹´ï¼‰ |
| `signedUrl` | ç»™æ¨¡å‹çš„çŸ­ç­¾å URLï¼ˆé»˜è®¤ 10 åˆ†é’Ÿï¼Œä¸”æ˜¯è·¯å¾„ç­¾åï¼‰ |

### ğŸ” 8.2 ä¸ºä»€ä¹ˆè¦"è·¯å¾„ç­¾å"

> âš ï¸ **è¿™æ˜¯ä¸ºäº†å¯¹æŠ—æ¨¡å‹ä¸¢ query**

æ¨¡å‹ä¾§ç»å¸¸å‡ºç°è¿™ç§æƒ…å†µï¼š

```
ä½ ç»™äº†ï¼šhttps://.../media/xxx?exp=...&sig=...
æ¨¡å‹è¯·æ±‚æ—¶æŠŠ ?exp&sig ä¸¢äº† â†’ 401
```

æ‰€ä»¥æˆ‘ä¸“é—¨ç»™æ¨¡å‹åšäº†ä¸€ç§å½¢å¼ï¼š

```
/media-s/<exp>/<sig>/<key>
```

è¿™ä¸ªç­¾ååœ¨è·¯å¾„é‡Œï¼Œä¸ä¾èµ– queryï¼Œæ¨¡å‹æ›´ä¸å®¹æ˜“ä¸¢ã€‚

**å®ç°è§**ï¼š
- [`server/src/utils/media-signature.ts`](server/src/utils/media-signature.ts) çš„ `signMediaUrlForModel`
- [`server/src/routes/media.ts`](server/src/routes/media.ts) çš„ `/media-s/...` è·¯ç”±

### ğŸ”’ 8.3 è®¿é—®æ§åˆ¶ä¼˜å…ˆçº§ï¼ˆç°çŠ¶ï¼‰

**è¯»å– `/media/:key+`**ï¼ˆç»™ Appï¼‰ï¼š

```
â‘  query ç­¾å exp/sig æ ¡éªŒé€šè¿‡
          â†“ï¼ˆå¤±è´¥åˆ™ç»§ç»­ï¼‰
â‘¡ Header X-App-Token æ ¡éªŒé€šè¿‡
          â†“ï¼ˆå¤±è´¥åˆ™ç»§ç»­ï¼‰
â‘¢ query ?token=<APP_TOKEN> æ ¡éªŒé€šè¿‡ï¼ˆå…¼å®¹å…œåº•ï¼Œä¸æ¨èï¼‰
```

**è¯»å– `/media-s/...`**ï¼ˆç»™æ¨¡å‹ï¼‰ï¼š

```
â‘  ä¼˜å…ˆæ ¡éªŒè·¯å¾„ç­¾å
          â†“ï¼ˆä¸é€šè¿‡ï¼‰
â‘¡ èµ° Header/query token å…œåº•
```

**ç­¾åç®—æ³•**ï¼š`HMAC-SHA256(key + "\n" + exp)`ï¼Œsecret ä¼˜å…ˆç”¨ `MEDIA_SIGNING_KEY`ï¼Œå¦åˆ™å›é€€ `APP_TOKEN`ã€‚

---

## 9. åç«¯ API å¥‘çº¦ï¼ˆå®Œæ•´ï½œå­—æ®µçº§ï¼‰

> ğŸ“Œ **ç»Ÿä¸€è§„åˆ™**ï¼šé™¤ `OPTIONS *` å¤–ï¼Œæ‰€æœ‰ä¸šåŠ¡æ¥å£éƒ½éœ€è¦ `X-App-Token`ï¼›è¿”å› JSONã€‚
> CORSï¼š`Access-Control-Allow-Origin: *`ã€‚
>
> ğŸ“Œ **åŒåç«¯ä¸€è‡´**ï¼šCloudflare Worker ç‰ˆå’Œ VPS ç‰ˆå¯¹å¤– API è·¯å¾„ä¿æŒä¸€è‡´ï¼Œå®¢æˆ·ç«¯æ— éœ€æ”¹ä»£ç ã€‚

ä¸‹é¢å†™çš„æ˜¯"ç°çŠ¶åè®®"ï¼Œç»§ç»­å¼€å‘è¯·ä»¥æ­¤ä¸ºåŸºå‡†ã€‚

---

### 9.1 `OPTIONS *`

ç”¨äºæµè§ˆå™¨é¢„æ£€ï¼Œè¿”å›ï¼š
```http
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, OPTIONS
Access-Control-Allow-Headers: Content-Type, X-App-Token, Authorization, X-File-Name, X-File-Type, X-File-Size, X-User-Id
```

---

### 9.2 `POST /api/v1/chat`ï¼ˆç”Ÿæˆå›å¤ï¼‰

<details>
<summary>ğŸ“‹ ç‚¹å‡»å±•å¼€è¯¦æƒ…</summary>

**Header**
```http
Content-Type: application/json
X-App-Token: <token>
```

**Request Bodyï¼ˆæ¨èå­—æ®µåï¼‰**
```json
{
  "userId": "uuid",
  "content": "æ–‡æœ¬ï¼Œå¯ä¸ºç©ºï¼ˆåªå‘å›¾æ—¶ï¼‰",
  "logId": "è¿™æ¡ç”¨æˆ·æ¶ˆæ¯åœ¨ DB çš„ idï¼ˆç”¨äºå»é‡ï¼Œå¯é€‰ï¼‰",
  "platform": "androidï¼ˆå¯é€‰ï¼‰",
  "userName": "å¯é€‰",
  "clientTimeIso": "2026-01-02T22:33:44+08:00ï¼ˆå¯é€‰ï¼‰",
  "modelKey": "ä¸Šæ¸¸æ¨¡å‹ idï¼ˆå¯é€‰ï¼‰",
  "imageUrl": "data:... æˆ– https://...ï¼ˆå¯é€‰ï¼‰",
  "attachments": [
    { "type": "image|document", "url": "https://.../media/...", "mime": "image/png", "name": "a.png", "sizeBytes": 123 }
  ],
  "timeZone": "Asia/Shanghaiï¼ˆå¯é€‰ï¼‰"
}
```

**Responseï¼ˆæˆåŠŸï¼‰**
```json
{
  "reply": "äºšæ‰˜è‰çš„å›å¤",
  "status": {
    "label": "é™ªç€ä½ ",
    "pillColor": "#E3F2FD",
    "textColor": "#FFFFFF"
  },
  "action": null,
  "intimacy": 12,
  "replyLogId": "uuid",
  "replyTimestamp": 1730000000000,
  "replyTo": "åŸ logId"
}
```

**å¸¸è§é”™è¯¯**
| çŠ¶æ€ç  | å“åº” | åŸå›  |
|:------:|------|------|
| 503 | `{"error":"app_token_missing"}` | åç«¯æ²¡é…ç½® `APP_TOKEN` |
| 401 | `{"error":"unauthorized"}` | Token ä¸åŒ¹é… |
| 400 | `{"error":"invalid_request","message":"..."}` | ç¼º userId æˆ–å®Œå…¨ç©ºæ¶ˆæ¯ |
| 500 | `{"error":"bio_chat_failed","details":"..."}` | ä¸Šæ¸¸æ¨¡å‹å¤±è´¥ç­‰ |

</details>

---

### 9.3 `POST /conversation/log`ï¼ˆå†™å…¥æ—¥å¿—ï¼‰

<details>
<summary>ğŸ“‹ ç‚¹å‡»å±•å¼€è¯¦æƒ…</summary>

**Header**
```http
Content-Type: application/json
X-App-Token: <token>
```

**Request Body**
```json
{
  "logId": "å¯é€‰ï¼ˆä½œä¸º id å†™å…¥ DBï¼‰",
  "userId": "uuid",
  "role": "user|atri",
  "content": "æ–‡æœ¬ï¼Œä¸èƒ½ä¸ºç©º",
  "timestamp": 1730000000000,
  "attachments": [
    { "type": "image|document", "url": "https://.../media/...", "mime": "image/png", "name": "a.png", "sizeBytes": 123 }
  ],
  "replyTo": "å¯é€‰ï¼ˆå›å¤çš„ç›®æ ‡æ¶ˆæ¯ idï¼‰",
  "userName": "å¯é€‰ï¼ˆç”¨æˆ·ä¾§æ˜µç§°ï¼‰",
  "timeZone": "Asia/Shanghaiï¼ˆå¯é€‰ï¼‰",
  "date": "2026-01-02ï¼ˆå¯é€‰ï¼‰"
}
```

**Responseï¼ˆæˆåŠŸï¼‰**
```json
{ "ok": true, "id": "æœ€ç»ˆå†™å…¥çš„id", "date": "YYYY-MM-DD" }
```

**é”™è¯¯**
| çŠ¶æ€ç  | å“åº” | åŸå›  |
|:------:|------|------|
| 400 | `{"error":"invalid_params"}` | ç¼º userId æˆ– role ä¸åˆæ³• |
| 400 | `{"error":"empty_content"}` | content ä¸ºç©º |
| 500 | `{"error":"log_failed"}` | å†™å…¥å¤±è´¥ |

</details>

---

### 9.4 `POST /conversation/delete`ï¼ˆæŒ‰ id æ‰¹é‡åˆ é™¤æ—¥å¿—ï¼‰

**Request**
```json
{ "userId": "uuid", "ids": ["id1","id2"] }
```

**Response**
```json
{ "ok": true, "deleted": 2 }
```

---

### 9.5 `GET /conversation/last`ï¼ˆæŸ¥è¯¢ä¸Šæ¬¡èŠå¤©æ—¥æœŸï¼‰

| Query å‚æ•° | å¿…å¡« | é»˜è®¤å€¼ |
|------------|:----:|--------|
| `userId` | âœ… | - |
| `timeZone` | âŒ | `Asia/Shanghai` |
| `date` | âŒ | æŒ‰ timeZone å–ä»Šå¤© |

**Response**
```json
// æ²¡æœ‰è®°å½•
{ "status": "missing" }

// æœ‰è®°å½•
{ "status": "ok", "date": "YYYY-MM-DD", "daysSince": 3 }
```

---

### 9.6 `GET /diary`ï¼ˆæŸ¥æŸå¤©æ—¥è®°ï¼‰

| Query å‚æ•° | å¿…å¡« |
|------------|:----:|
| `userId` | âœ… |
| `date` | âœ… (YYYY-MM-DD) |

**Response**
```json
// ä¸å­˜åœ¨
{ "status": "missing" }

// å­˜åœ¨
{ "status": "ready|pending|error", "entry": { ... } }
```

---

### 9.7 `GET /diary/list`ï¼ˆåˆ—æ—¥è®°ï¼‰

| Query å‚æ•° | å¿…å¡« | é»˜è®¤å€¼ |
|------------|:----:|--------|
| `userId` | âœ… | - |
| `limit` | âŒ | 7ï¼ˆæœ€å¤§ 30ï¼‰ |

**Response**
```json
{
  "entries": [
    {
      "id": "diary:...",
      "date": "YYYY-MM-DD",
      "summary": "...",
      "content": "...",
      "mood": "...",
      "status": "ready",
      "createdAt": 0,
      "updatedAt": 0
    }
  ]
}
```

---

### 9.8 `POST /diary/regenerate`ï¼ˆé‡ç”ŸæˆæŸå¤©æ—¥è®°ï¼‰

**Request**
```json
{ "userId": "uuid", "date": "YYYY-MM-DD" }
```

**Responseï¼ˆæˆåŠŸï¼‰**
```json
{ "status": "ready", "entry": { ... } }
```

**å¸¸è§é”™è¯¯**
| çŠ¶æ€ç  | å“åº” | åŸå›  |
|:------:|------|------|
| 404 | `{"error":"no_conversation_logs"}` | å½“å¤©æ²¡æœ‰å¯¹è¯æ—¥å¿— |
| 500 | `{"status":"error","error":"..."}` | ç”Ÿæˆå¤±è´¥ |

---

### 9.9 `POST /upload`ï¼ˆä¸Šä¼ é™„ä»¶ï¼‰

**Header**
```http
X-App-Token: <token>
X-File-Name: filename.png
X-File-Type: image/png
X-File-Size: 12345
X-User-Id: uuid
```

**Body**ï¼šæ–‡ä»¶äºŒè¿›åˆ¶

**Response**
```json
{
  "key": "u/xxx/173...-a.png",
  "url": "ç»™Appç”¨çš„é•¿ç­¾åURLï¼ˆå¯èƒ½å¸¦ exp/sigï¼‰",
  "signedUrl": "ç»™æ¨¡å‹ç”¨çš„è·¯å¾„ç­¾åURLï¼ˆ/media-s/...ï¼‰",
  "rawUrl": "ä¸ç­¾åçš„URL",
  "mime": "image/png",
  "size": 123
}
```

---

### 9.10 `GET/HEAD /media/:key+`ï¼ˆè¯»å–é™„ä»¶ï¼‰

å…è®¸ä¸‰ç§æ–¹å¼æ”¾è¡Œï¼ˆè§ç¬¬ 8 èŠ‚ï¼‰ã€‚æˆåŠŸä¼šè¿”å›å¯¹è±¡å†…å®¹ï¼Œå¹¶å¸¦ï¼š
```http
Cache-Control: public, max-age=31536000
```

---

### 9.11 `GET/HEAD /media-s/:exp/:sig/:key+`ï¼ˆè·¯å¾„ç­¾åè¯»å–é™„ä»¶ï¼‰

ç»™æ¨¡å‹ç”¨çš„ç¨³å®šå½¢å¼ï¼Œè§ç¬¬ 8 èŠ‚ã€‚

---

### 9.12 `GET /models`ï¼ˆæ¨¡å‹åˆ—è¡¨ï¼‰

ä»£ç†è¯·æ±‚ä¸Šæ¸¸æ¨¡å‹åˆ—è¡¨ï¼Œå½’ä¸€æˆï¼š
```json
{
  "models": [
    { "id": "...", "label": "...", "provider": "...", "note": "..." }
  ]
}
```

---

### 9.13 `POST /admin/clear-user`ï¼ˆæ¸…ç†ç”¨æˆ·æ•°æ®ï¼‰

<details>
<summary>ğŸ“‹ ç‚¹å‡»å±•å¼€è¯¦æƒ…</summary>

**Header**
```http
Authorization: Bearer <ADMIN_API_KEY>
```

**Request**
```json
{ "userId": "uuid" }
```

**Response**
```json
{
  "ok": true,
  "userId": "uuid",
  "stats": {
    "diaries": 10,
    "diaryVectors": 100,
    "conversationLogs": 200,
    "mediaObjects": 5,
    "userSettings": 1
  }
}
```

</details>

---

### 9.14 å…¼å®¹ API ç«¯ç‚¹ï¼ˆä»… VPSï¼‰

VPS åç«¯é¢å¤–æä¾›ä¸‰ç»„å…¼å®¹ç«¯ç‚¹ï¼Œè®©ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ï¼ˆå¦‚ ChatGPT ç±»å·¥å…·ï¼‰ç›´æ¥æ¥å…¥ï¼š

| ç«¯ç‚¹ | é‰´æƒæ–¹å¼ | æ ¼å¼ |
|------|----------|------|
| `POST /v1/chat/completions` | `Authorization: Bearer <COMPAT_API_KEY>` | OpenAI æ ¼å¼ |
| `POST /v1/messages` | `x-api-key` æˆ– `Authorization: Bearer` | Anthropic æ ¼å¼ |
| `POST /v1beta/models/:model:generateContent` | `key` query æˆ– `x-goog-api-key` header | Gemini æ ¼å¼ |

> âš ï¸ å…¼å®¹ç«¯ç‚¹ä¸æ”¯æŒ `stream=true`ï¼Œä»…æ”¯æŒä¸€æ¬¡æ€§ JSON è¿”å›ã€‚
>
> ğŸ“Œ å…¼å®¹ç«¯ç‚¹ä¼šè‡ªåŠ¨åˆ›å»ºåŒ¿åç”¨æˆ·ï¼ˆåŸºäº API key çš„ SHA-256 å“ˆå¸Œï¼‰ï¼Œå¹¶è®°å½•å¯¹è¯æ—¥å¿—ã€‚

---

### 9.15 ç®¡ç†åå° APIï¼ˆä»… VPSï¼‰

ç®¡ç†åå°é€šè¿‡ `ADMIN_API_KEY` é‰´æƒï¼Œæä¾›ï¼š

| ç«¯ç‚¹ | åŠŸèƒ½ |
|------|------|
| `GET /admin/config` | è¯»å–è¿è¡Œæ—¶é…ç½®ï¼ˆpublic éƒ¨åˆ† + secrets å­˜åœ¨æ€§ï¼‰ |
| `PATCH /admin/config` | æ›´æ–°è¿è¡Œæ—¶é…ç½®å’Œå¯†é’¥ï¼ˆAES-256-GCM åŠ å¯†å­˜å‚¨ï¼‰ |
| `DELETE /admin/config` | é‡ç½®è¿è¡Œæ—¶é…ç½® |
| `GET /admin/prompts` | è¯»å–æç¤ºè¯è¦†ç›– |
| `PUT /admin/prompts` | æ›´æ–°æç¤ºè¯è¦†ç›– |
| `DELETE /admin/prompts` | é‡ç½®æç¤ºè¯è¦†ç›– |
| `GET /admin/logs` | è¯»å–åº”ç”¨æ—¥å¿—ç¼“å†² |

---

## 10. æ•°æ®æ¨¡å‹ï¼ˆå®Œæ•´ï½œPostgreSQL / æœ¬åœ°å­˜å‚¨ / Android æœ¬åœ°ï¼‰

### ğŸ—„ï¸ 10.1 PostgreSQLï¼ˆ[`server/src/services/db-bootstrap.ts`](server/src/services/db-bootstrap.ts) è‡ªåŠ¨å»ºè¡¨ï¼‰

<table>
<tr>
<th colspan="2">conversation_logsï¼ˆå¯¹è¯æ—¥å¿—ï¼‰</th>
</tr>
<tr>
<td><code>id</code></td>
<td>ä¸»é”®ï¼ˆå®¢æˆ·ç«¯å¯ä¼  logIdï¼Œå¦åˆ™åç«¯ç”Ÿæˆ UUIDï¼‰</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>ç”¨æˆ· id</td>
</tr>
<tr>
<td><code>date</code></td>
<td>YYYY-MM-DDï¼ˆä¼˜å…ˆç”¨å®¢æˆ·ç«¯ä¼ å…¥ dateï¼Œå¦åˆ™æŒ‰ timestamp+timeZone è®¡ç®—ï¼‰</td>
</tr>
<tr>
<td><code>role</code></td>
<td><code>user|atri</code></td>
</tr>
<tr>
<td><code>content</code></td>
<td>æ¸…æ´—åçš„æ–‡æœ¬</td>
</tr>
<tr>
<td><code>attachments</code></td>
<td>JSON å­—ç¬¦ä¸²ï¼ˆæ•°ç»„ï¼‰</td>
</tr>
<tr>
<td><code>reply_to</code></td>
<td>å›å¤ç›®æ ‡æ¶ˆæ¯ idï¼ˆå¯é€‰ï¼‰</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>æ¯«ç§’</td>
</tr>
<tr>
<td><code>user_name</code></td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>time_zone</code></td>
<td>å¯é€‰</td>
</tr>
<tr>
<td><code>created_at</code></td>
<td>å†™å…¥æ—¶é—´</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">conversation_log_tombstonesï¼ˆåˆ é™¤æ ‡è®°ï¼‰</th>
</tr>
<tr>
<td><code>user_id</code> + <code>log_id</code></td>
<td>å¤åˆä¸»é”®ï¼Œè®°å½•å·²åˆ é™¤çš„æ—¥å¿— ID</td>
</tr>
<tr>
<td><code>deleted_at</code></td>
<td>åˆ é™¤æ—¶é—´æˆ³</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">user_statesï¼ˆç”¨æˆ·çŠ¶æ€ï¼‰</th>
</tr>
<tr>
<td><code>status_label</code></td>
<td>çŠ¶æ€èƒ¶å›Šæ–‡æ¡ˆï¼ˆå¦‚"é™ªç€ä½ "ï¼‰</td>
</tr>
<tr>
<td><code>status_pill_color</code></td>
<td>èƒ¶å›Šåº•è‰² HEXï¼ˆå¦‚ #E3F2FDï¼‰</td>
</tr>
<tr>
<td><code>status_text_color</code></td>
<td>èƒ¶å›Šæ–‡å­—é¢œè‰² HEXï¼ˆå¦‚ #FFFFFFï¼‰</td>
</tr>
<tr>
<td><code>status_reason</code></td>
<td>çŠ¶æ€åŸå› ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰</td>
</tr>
<tr>
<td><code>status_updated_at</code></td>
<td>çŠ¶æ€æ›´æ–°æ—¶é—´æˆ³</td>
</tr>
<tr>
<td><code>intimacy</code></td>
<td>å…³ç³»æ¸©åº¦ï¼ˆ-100 ~ 100ï¼‰</td>
</tr>
<tr>
<td><code>last_interaction_at</code> / <code>updated_at</code></td>
<td>ç”¨äºè¡°å‡ä¸æ›´æ–°</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">diary_entriesï¼ˆæ—¥è®°ï¼‰</th>
</tr>
<tr>
<td><code>id</code></td>
<td><code>diary:&lt;userId&gt;:&lt;date&gt;</code></td>
</tr>
<tr>
<td><code>summary</code></td>
<td>highlights æ‹¼æ¥æˆ–æ­£æ–‡æ‘˜è¦</td>
</tr>
<tr>
<td><code>content</code></td>
<td>æ—¥è®°æ­£æ–‡</td>
</tr>
<tr>
<td><code>mood</code></td>
<td>ä¸€ä¸ªè¯</td>
</tr>
<tr>
<td><code>status</code></td>
<td><code>pending|ready|error</code></td>
</tr>
</table>

<table>
<tr>
<th colspan="2">user_settingsï¼ˆç”¨æˆ·è®¾ç½®ï¼‰</th>
</tr>
<tr>
<td><code>model_key</code></td>
<td>ç”¨æˆ·åå¥½æ¨¡å‹</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">user_profilesï¼ˆç”¨æˆ·æ¡£æ¡ˆï¼‰</th>
</tr>
<tr>
<td><code>content</code></td>
<td>JSON å­—ç¬¦ä¸²ï¼ˆäº‹å®/å–œå¥½/é›·åŒº/è¯´è¯é£æ ¼/å…³ç³»è¿›å±•ï¼‰</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">memory_vectorsï¼ˆå‘é‡è®°å¿† â€” pgvectorï¼‰</th>
</tr>
<tr>
<td><code>id</code></td>
<td>ä¸»é”®ï¼š<code>hl:&lt;userId&gt;:&lt;date&gt;:&lt;i&gt;</code>ï¼ˆæ—¥è®° highlightsï¼‰æˆ– <code>fact:&lt;userId&gt;:&lt;hash&gt;</code>ï¼ˆå®æ—¶äº‹å®ï¼‰</td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>ç”¨æˆ· id</td>
</tr>
<tr>
<td><code>date</code></td>
<td>æ—¥æœŸ</td>
</tr>
<tr>
<td><code>idx</code></td>
<td>åºå·ï¼ˆfacts ä¸º -1ï¼‰</td>
</tr>
<tr>
<td><code>text</code></td>
<td>åŸæ–‡</td>
</tr>
<tr>
<td><code>mood</code></td>
<td>æƒ…ç»ªæ ‡ç­¾ï¼ˆfacts ä¸º <code>system_fact</code>ï¼‰</td>
</tr>
<tr>
<td><code>importance</code></td>
<td>é‡è¦åº¦ï¼ˆhighlights=6, facts=10ï¼‰</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>å†™å…¥æ—¶é—´æˆ³</td>
</tr>
<tr>
<td><code>embedding</code></td>
<td><code>vector(1024)</code> â€” pgvector ç±»å‹</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">admin_runtime_configï¼ˆè¿è¡Œæ—¶é…ç½®ï¼‰</th>
</tr>
<tr>
<td><code>config_json</code></td>
<td>å…¬å¼€é…ç½® JSONï¼ˆAPI æ ¼å¼ã€URLã€æ¸©åº¦ã€token æ•°ç­‰ï¼‰</td>
</tr>
<tr>
<td><code>secrets_*</code></td>
<td>AES-256-GCM åŠ å¯†çš„å¯†é’¥ï¼ˆciphertext + iv + tagï¼‰</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">admin_prompts_overrideï¼ˆæç¤ºè¯è¦†ç›–ï¼‰</th>
</tr>
<tr>
<td><code>prompts_json</code></td>
<td>è¦†ç›–çš„æç¤ºè¯ JSONï¼ˆagent/diary/profile/proactive çš„ system å’Œ userTemplateï¼‰</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">proactive_messagesï¼ˆä¸»åŠ¨æ¶ˆæ¯è®°å½•ï¼‰</th>
</tr>
<tr>
<td><code>id</code></td>
<td>ä¸»é”®ï¼š<code>pm:&lt;logId&gt;</code></td>
</tr>
<tr>
<td><code>user_id</code></td>
<td>ç”¨æˆ· id</td>
</tr>
<tr>
<td><code>content</code></td>
<td>ä¸»åŠ¨æ¶ˆæ¯æ–‡æœ¬</td>
</tr>
<tr>
<td><code>trigger_context</code></td>
<td>è§¦å‘ä¸Šä¸‹æ–‡ JSONï¼ˆintimacy/hoursSince/localHour ç­‰ï¼‰</td>
</tr>
<tr>
<td><code>status</code></td>
<td><code>pending|delivered|expired</code></td>
</tr>
<tr>
<td><code>notification_channel</code></td>
<td><code>none|email|wechat_work</code></td>
</tr>
<tr>
<td><code>notification_sent</code></td>
<td>å¤–éƒ¨é€šçŸ¥æ˜¯å¦å·²å‘é€</td>
</tr>
<tr>
<td><code>expires_at</code></td>
<td>è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 72 å°æ—¶åï¼‰</td>
</tr>
</table>

<table>
<tr>
<th colspan="2">proactive_user_statesï¼ˆä¸»åŠ¨æ¶ˆæ¯ç”¨æˆ·çŠ¶æ€ï¼‰</th>
</tr>
<tr>
<td><code>user_id</code></td>
<td>ç”¨æˆ· id</td>
</tr>
<tr>
<td><code>last_proactive_at</code></td>
<td>ä¸Šæ¬¡ä¸»åŠ¨æ¶ˆæ¯æ—¶é—´æˆ³</td>
</tr>
<tr>
<td><code>daily_count</code> / <code>daily_count_date</code></td>
<td>å½“æ—¥å·²å‘é€æ•°é‡ä¸å¯¹åº”æ—¥æœŸ</td>
</tr>
</table>

### ğŸ“¦ 10.2 æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆVPS é™„ä»¶å­˜å‚¨ï¼‰

```
MEDIA_ROOT/
  u/<safeUser>/<timestamp>-<safeName>          # é™„ä»¶æ–‡ä»¶
  u/<safeUser>/<timestamp>-<safeName>.meta.json # å…ƒæ•°æ®ï¼ˆcontentType ç­‰ï¼‰
```

### ğŸ“± 10.3 Android æœ¬åœ°ï¼ˆRoom + DataStoreï¼‰

**Room**ï¼š[`ATRI/app/src/main/java/me/atri/data/db/AtriDatabase.kt`](ATRI/app/src/main/java/me/atri/data/db/AtriDatabase.kt)

| è¡¨ | è¯´æ˜ |
|---|---|
| `messages` | æ¶ˆæ¯ï¼ˆå¸¦ isDeleted/isImportant/versionï¼‰ |
| `message_versions` | æ¶ˆæ¯ç‰ˆæœ¬ï¼ˆç”¨äºç¼–è¾‘/é‡ç­”ï¼‰ |
| `diary` | æœ¬åœ°ç¼“å­˜æ—¥è®°ï¼ˆå½“å‰ä¸»è¦ç”¨äºå±•ç¤ºï¼‰ |
| `memories` | æœ¬åœ°è®°å¿†è¡¨ï¼ˆæ›´å¤šç”¨äºç»Ÿè®¡/é¢„ç•™ï¼‰ |

**DataStore**ï¼š[`PreferencesStore.kt`](ATRI/app/src/main/java/me/atri/data/datastore/PreferencesStore.kt)

| Key | è¯´æ˜ |
|-----|------|
| `api_url` | Server URL |
| `app_token` | é‰´æƒ token |
| `model_name` | æ¨¡å‹ id |
| `user_id` / `user_name` | ç”¨æˆ·ä¿¡æ¯ |
| `last_chat_date` | ç¦»çº¿å…œåº• |

---

## 11. å¼€å‘è€…ä¸Šæ‰‹ï¼ˆæ€ä¹ˆæ”¹ä¸œè¥¿ï¼Œä¸è®²éƒ¨ç½²ï¼‰

### ğŸ”§ 11.1 ä½ æœ€å¸¸æ”¹çš„ä¸œè¥¿ â†’ æ”¹å“ªå„¿

| ä½ æƒ³æ”¹ä»€ä¹ˆ | æ”¹å“ªäº›æ–‡ä»¶ |
|------------|------------|
| ğŸ­ æ”¹äººæ ¼/å£å»/å·¥å…·ä½¿ç”¨è§„åˆ™ | [`shared/prompts.json`](shared/prompts.json) çš„ `agent`ï¼ˆæˆ–é€šè¿‡ç®¡ç†åå°åœ¨çº¿ç¼–è¾‘ï¼‰ |
| ğŸ“” æ”¹æ—¥è®°å†™æ³• | [`shared/prompts.json`](shared/prompts.json) çš„ `diary` |
| ğŸ“‹ æ”¹ç”¨æˆ·æ¡£æ¡ˆç»“æ„ | [`shared/prompts.json`](shared/prompts.json) çš„ `profile` + [`server/src/services/profile-generator.ts`](server/src/services/profile-generator.ts) |
| ğŸ”§ åŠ ä¸€ä¸ªæ–°å·¥å…· | [`server/src/services/agent-service.ts`](server/src/services/agent-service.ts)ï¼ˆAGENT_TOOLS + executeAgentToolï¼‰ |
| ğŸ§  æ”¹å‘é‡è®°å¿†ç­–ç•¥ | [`server/src/services/memory-service.ts`](server/src/services/memory-service.ts) |
| ğŸ“¬ æ”¹ä¸»åŠ¨æ¶ˆæ¯é€»è¾‘ | [`server/src/services/proactive-service.ts`](server/src/services/proactive-service.ts) |
| ğŸ“œ æ”¹ä¸Šä¸‹æ–‡æ„å»º | [`server/src/services/history-context.ts`](server/src/services/history-context.ts)ï¼ˆä¸»å¯¹è¯+ä¸»åŠ¨æ¶ˆæ¯å…±ç”¨ï¼‰ |
| ğŸ” æ”¹é™„ä»¶å®‰å…¨/ç­¾å | [`server/src/utils/media-signature.ts`](server/src/utils/media-signature.ts) + [`server/src/routes/media.ts`](server/src/routes/media.ts) |
| ğŸŒ æ”¹ LLM æ ¼å¼é€‚é… | [`server/src/services/llm-service.ts`](server/src/services/llm-service.ts) |
| âš™ï¸ æ”¹è¿è¡Œæ—¶é…ç½®ç³»ç»Ÿ | [`server/src/services/runtime-settings.ts`](server/src/services/runtime-settings.ts) |
| ğŸ“± App å¢åŠ /è°ƒç”¨æ–°æ¥å£ | [`ATRI/.../AtriApiService.kt`](ATRI/app/src/main/java/me/atri/data/api/AtriApiService.kt) + Repository + ViewModel + UI |

### ğŸš€ 11.2 "å·¥å…·æ³¨å†Œ"æ‰©å±•çš„æ ‡å‡†å§¿åŠ¿

> æ¨èæµç¨‹

```
â‘  å…ˆæƒ³æ¸…æ¥šï¼šè¿™ä¸ªèƒ½åŠ›æ˜¯"è¯»äº‹å®"ï¼ˆé€‚åˆå·¥å…·ï¼‰ï¼Œè¿˜æ˜¯"ç”Ÿæˆæ–‡æœ¬"ï¼ˆé€‚åˆæ¨¡å‹ç›´æ¥å›ç­”ï¼‰
                    â†“
â‘¡ åŠ å·¥å…· schemaï¼ˆè®©æ¨¡å‹çŸ¥é“å‚æ•°æ˜¯ä»€ä¹ˆï¼‰
                    â†“
â‘¢ å®ç°å·¥å…·æ‰§è¡Œï¼ˆå¿…é¡»è¿”å›å¯è¯»çš„ã€å¯ä¿¡çš„å†…å®¹ï¼‰
                    â†“
â‘£ åœ¨ prompts é‡Œå†™æ¸…æ¥š"ä»€ä¹ˆæ—¶å€™è¯¥ç”¨å®ƒ"ï¼ˆå¦åˆ™æ¨¡å‹ä¸ä¼šç”¨/ä¹±ç”¨ï¼‰
```

---

## 12. æœªæ¥æ¼”è¿›ï¼ˆä½ è®¡åˆ’çš„æ–¹å‘ï¼Œå†™åœ¨è“å›¾é‡Œæ–¹ä¾¿åç»­å¯¹é½ï¼‰

> ğŸ“Œ è¿™ä¸€èŠ‚åªè®²"è®¡åˆ’æ€ä¹ˆæ‰©"ï¼Œä¸å½±å“ç°çŠ¶å®ç°ã€‚

### âœ… 12.1 å·²å®Œæˆï¼šåŸç”Ÿå¤šæ ¼å¼æ”¯æŒ

**å·²å®ç°**ï¼š`llm-service.ts` æ”¯æŒ OpenAIã€Anthropicã€Gemini ä¸‰ç§åŸç”Ÿ API æ ¼å¼ï¼Œé€šè¿‡ `chatApiFormat` / `diaryApiFormat` é…ç½®åˆ‡æ¢ã€‚

### âœ… 12.2 å·²å®Œæˆï¼šä¸»åŠ¨æ¶ˆæ¯ï¼ˆATRI å…ˆå¼€å£ï¼‰

**å·²å®ç°**ï¼šåç«¯å®šæ—¶è¯„ä¼°æ˜¯å¦åº”è¯¥ä¸»åŠ¨è¯´è¯ï¼Œå¹¶ç”Ÿæˆ `role=atri` çš„æ¶ˆæ¯å†™å…¥ `conversation_logs`ã€‚

**æ ¸å¿ƒæœºåˆ¶**ï¼ˆ[`server/src/services/proactive-service.ts`](server/src/services/proactive-service.ts)ï¼‰ï¼š

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| è§¦å‘æ–¹å¼ | åç«¯å®šæ—¶è°ƒåº¦ï¼ˆé»˜è®¤æ¯ 60 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰ |
| ä¸Šä¸‹æ–‡ | ä¸ä¸»å¯¹è¯ä¸€è‡´çš„ä¸¤å¤©å†å²çª—å£ï¼ˆå…±ç”¨ `history-context.ts`ï¼‰ |
| åˆ¤æ–­é€»è¾‘ | æ¨¡å‹è‡ªä¸»å†³å®šâ€”â€”è®¤ä¸ºè¯¥è¯´å°±è¯´ï¼Œä¸è¯¥æ‰“æ‰°å°±è¾“å‡º `[SKIP]` |
| æ¶ˆæ¯è½åº“ | å†™å…¥ `conversation_logs`ï¼ˆrole=atriï¼‰+ `proactive_messages` è¡¨ |
| å¤–éƒ¨é€šçŸ¥ | æ¨¡å‹å¯è°ƒç”¨ `send_notification` å·¥å…·ï¼Œæ”¯æŒ Emailï¼ˆResendï¼‰å’Œä¼ä¸šå¾®ä¿¡ Webhook |
| é¢‘ç‡æ§åˆ¶ | å®‰é™æ—¶æ®µã€æ¯æ—¥ä¸Šé™ã€å†·å´æ—¶é—´ã€äº²å¯†åº¦é—¨æ§›ã€æœ€è¿‘æ´»è·ƒè¿‡æ»¤ |

**é…ç½®æ–¹å¼**ï¼ˆå…¨éƒ¨åœ¨ `/admin` ç®¡ç†åå°ï¼Œæ— éœ€é‡å¯ï¼‰ï¼š

1. **Runtime Config** â†’ å¼€å¯ä¸»åŠ¨æ¶ˆæ¯ï¼Œè®¾ç½®æ£€æŸ¥é—´éš”ã€å®‰é™æ—¶æ®µã€æ¯æ—¥ä¸Šé™ã€å†·å´å°æ—¶æ•°
2. **é€šçŸ¥æ¸ é“**ï¼ˆå¯é€‰ï¼‰â†’ é€‰ `none` åˆ™ä»…åº”ç”¨å†…æ¶ˆæ¯ï¼Œé€‰ `email` / `wechat_work` åˆ™éœ€è¦é…ç½®ç›¸åº”å‡­æ®
3. **Prompt Editor** â†’ ç¼–è¾‘ `proactive.system`ï¼Œå¯ç”¨å ä½ç¬¦ï¼š`{clock_time}` `{hours_since}` `{intimacy}` `{user_profile_snippet}`

**Email é€šçŸ¥éœ€è¦é¢å¤–ç¯å¢ƒå˜é‡**ï¼š
```env
EMAIL_API_KEY=re_xxx
EMAIL_FROM=ATRI <atri@your-domain.com>
```

> ğŸ“Œ ä¸»åŠ¨æ¶ˆæ¯çš„ä¸Šä¸‹æ–‡ä¸ä¸»å¯¹è¯å®Œå…¨å¯¹é½ï¼ˆä¸¤å¤©å†å²çª—å£ï¼‰ï¼Œä¿è¯ä¸»åŠ¨æ¶ˆæ¯çš„è¯­å¢ƒè¿è´¯æ€§ã€‚

### ğŸ”Š 12.3 SSE æµå¼è¾“å‡º

**ç°çŠ¶**ï¼šèŠå¤©æ¥å£æ˜¯ä¸€æ¬¡æ€§ JSON è¿”å›ã€‚

**æ¼”è¿›æ–¹å‘**ï¼šæ”¯æŒ SSE æµå¼è¾“å‡ºï¼Œè®©å›å¤å¯ä»¥é€å­—æ˜¾ç¤ºï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚éœ€è¦è€ƒè™‘å·¥å…·å¾ªç¯ä¸­é—´ç»“æœçš„æµå¼å¤„ç†ã€‚

---

## é™„å½• Aï¼šæœ€å°"è‡ªæ£€æ¸…å•"ï¼ˆä¸ç­‰äºéƒ¨ç½²ï¼‰

> âœ… ä½ è¦éªŒè¯ç³»ç»Ÿ"è®¾è®¡é“¾è·¯"æ˜¯å¦é€šï¼Œæœ€å°‘çœ‹è¿™ä¸‰ä»¶äº‹ï¼š

| # | æ£€æŸ¥é¡¹ | å¦‚ä½•éªŒè¯ |
|:-:|--------|----------|
| 1ï¸âƒ£ | `/api/v1/chat` èƒ½è¿”å› `reply/status/intimacy` | å‘ä¸€æ¡æ¶ˆæ¯ï¼Œæ£€æŸ¥å“åº”æ ¼å¼ |
| 2ï¸âƒ£ | `/conversation/log` å†™å…¥åï¼Œ`/conversation/last` èƒ½æŸ¥åˆ°æ—¥æœŸ | å†™å…¥æ—¥å¿—ï¼ŒæŸ¥è¯¢ç¡®è®¤ |
| 3ï¸âƒ£ | `/diary/regenerate` åœ¨å½“å¤©æœ‰æ—¥å¿—æ—¶èƒ½ç”Ÿæˆ `ready` æ—¥è®°ï¼Œå¹¶ä¸”åç»­ `search_memory` èƒ½å¬å›åˆ°é‚£å¤© | é‡ç”Ÿæˆæ—¥è®°ï¼Œæµ‹è¯•è®°å¿†æ£€ç´¢ |

---

<div align="center">

---

**ğŸ“– ç›¸å…³æ–‡æ¡£**

[`README.md`](README.md) Â· [`shared/prompts.json`](shared/prompts.json) Â· [`server/src/services/db-bootstrap.ts`](server/src/services/db-bootstrap.ts)

---

<sub>Built with â¤ï¸ for those who believe AI can be more than just a tool</sub>

</div>
